# shellcheck shell=bash

__setup_systemd()
{
  # If systemd assumes we have 256 colors, it displays a weird yellow for example.
  # Our terminal color scheme only handles 16
  export SYSTEMD_COLORS=16
}

__setup_editor()
{
  # User editor can be from a local script
  # Use absolute path to editor
  _editors="${HOME}/.local/bin/lvim ${HOME}/.containers/bin/nvim ${HOME}/.bww/bin/nvim /opt/homebrew/bin/nvim /usr/bin/nvim /usr/bin/vim /usr/bin/vi"
  for e in ${_editors}; do
    if [ -f "${e}" ]; then
      export EDITOR="${e}"
      export SYSTEMD_EDITOR="${e}"
      export SUDO_EDITOR="${e}"
      break
    fi
  done;
  unset _editors

  return 0
}

__setup_locale()
{
  # Incase LANG is not defined since Java and other tools nolikey POSIX
  # May be UserLand related on Android
  export LANG="en_US.UTF-8"
  export LANGUAGE="en_US.UTF-8"
  export LC_CTYPE="en_US.UTF-8"
  export LC_NUMERIC="en_US.UTF-8"
  export LC_TIME="en_US.UTF-8"
  export LC_COLLATE="en_US.UTF-8"
  export LC_MONETARY="en_US.UTF-8"
  export LC_MESSAGES="en_US.UTF-8"
  export LC_PAPER="en_US.UTF-8"
  export LC_NAME="en_US.UTF-8"
  export LC_ADDRESS="en_US.UTF-8"
  export LC_TELEPHONE="en_US.UTF-8"
  export LC_MEASUREMENT="en_US.UTF-8"
  export LC_IDENTIFICATION="en_US.UTF-8"
}

__setup_path()
{
  # MacOS doesn't have /usr/local/sbin by default.
  # If we made it, add it
  if [ "$(uname)" = "Darwin" ]; then
    if [ -d "/usr/local/sbin" ]; then
      PATH="/usr/local/sbin:${PATH}"
    fi  
  fi

  # Linux stuff
  if [ "$(uname)" = "Linux" ]; then
    # bubblewrap-wrap scripts
    if command -v bubblewrap > /dev/null; then
      if [ -d "${HOME}/.bww/bin" ]; then
        PATH="${HOME}/.bww/bin:${PATH}"
      fi
    fi

    # Flatpak scrips
    if command -v flatpak > /dev/null; then
      if [ -d "${HOME}/.flatpak/bin" ]; then
        PATH="${HOME}/.flatpak/bin:${PATH}"
      fi
    fi
  fi

  # Docker scrips
  if command -v docker > /dev/null || command -v podman > /dev/null; then
    if [ -d "${HOME}/.containers/bin" ]; then
      PATH="${HOME}/.containers/bin:${PATH}"
    fi
  fi

  # Add local npm repository: used for things like bash-language-server
  # Set the local npm global path with "npm config set prefix ~/.npm/global"
  if command -v npm > /dev/null; then
    # Don't add the path if we double up on homebrew
    _npm_path="$(npm config get prefix)"
    if [ "${_npm_path}" != "/opt/homebrew" ]; then
      PATH="${_npm_path}/bin:${PATH}"
    fi
  fi

  # Add Jetbrains Toolbox scripts (generally MacOS)
  if [ -d /opt/jetbrains ]; then
    PATH="/opt/jetbrains:${PATH}"
  fi

  # Git tracked scripts
  if [ -d "${HOME}/bin" ]; then
    PATH="${HOME}/bin:${PATH}"
  fi

  # Local scripts that are not git tracked
  if [ -d "${HOME}/.local/bin" ]; then
    PATH="${HOME}/.local/bin:${PATH}"
  fi

  # Export the PATH
  export PATH
}

__setup_homebrew()
{
  # Add homebrew scripts (generally MacOS)
  if [ -e /opt/homebrew/bin/brew ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
}

__setup_xdg()
{
  # Define XDG directories
  export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-${HOME}/.config}"
  export XDG_CACHE_HOME="${XDG_CACHE_HOME:-${HOME}/.cache}"
  export XDG_DATA_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}"
  export XDG_STATE_HOME="${XDG_STATE_HOME:-${HOME}/.local/state}"
}

__setup_homedir()
{
  # Suggestions from xdg-ninja
  export INPUTRC="${XDG_CONFIG_HOME}/readline/inputrc"
  export ICEAUTHORITY="${XDG_CACHE_HOME}/ICEauthority"
  export LESSHISTFILE="${XDG_CACHE_HOME}/less/history"
  export GNUPGHOME="${XDG_DATA_HOME}/gnupg"
}

__environment()
{
  # If we have already been sourced, exit out
  if [ -n "${PYAMSOFT_ENVIRONMENT}" ]; then
    return 0
  fi

  __setup_homebrew || return 1
  __setup_path || return 1
  __setup_xdg || return 1
  __setup_systemd || return 1
  __setup_editor || return 1
  __setup_locale || return 1

  # Expect XDG to be setup
  __setup_homedir || return 1

  # Mark environment as set up
  export PYAMSOFT_ENVIRONMENT=1

  return 0
}

__environment

unset -f __environment
unset -f __setup_homebrew
unset -f __setup_xdg
unset -f __setup_path
unset -f __setup_locale
unset -f __setup_editor
unset -f __setup_homedir
unset -f __setup_systemd

# vim: set syntax=sh tabstop=2 softtabstop=2 shiftwidth=2 shiftround expandtab:
