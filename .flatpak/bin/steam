#!/bin/sh

self="$(id -un)"
readonly self

readonly pak="com.valvesoftware.Steam"
readonly def_path="/app/bin:/usr/bin"
readonly path="${HOME}/.local/bin:/usr/lib/extensions/vulkan/gamescope/bin"

cmd=""
if [ "$1" = "--shell" ]; then
  cmd="${cmd} --shell"
  shift
fi
readonly cmd

# Gamescope LD_LIBRARY_PATH fix
readonly _gamescope_ld_path="/usr/lib/extensions/vulkan/gamescope/lib"
_def_ld_path=""
if [ -n "${LD_LIBRARY_PATH}" ]; then
  _def_ld_path=":${LD_LIBRARY_PATH}"
else
  _def_ld_path=""
fi
readonly _def_ld_path

# Sometimes steam messes up and deletes our library paths
# https://wiki.archlinux.org/title/Steam/Troubleshooting#Cannot_browse_filesystem_to_add_a_library_folder_or_library_folder_appears_as_empty
if [ -e "/storage/${self}/games/steam" ]; then
  touch "/storage/${self}/games/steam" || return 1
fi
if [ -e "/storage/${self}/games2/steam" ]; then
  touch "/storage/${self}/games2/steam" || return 1
fi

# shellcheck disable=SC2086
exec flatpak-env ${cmd} "${pak}" \
  --with-env PATH "${path}:" "${def_path}" \
  --with-env LD_LIBRARY_PATH "${_gamescope_ld_path}" "${_def_ld_path}" \
  --filesystem="/home/${self}/games/steam" \
  --filesystem="/storage/${self}/games/steam" \
  --filesystem="/storage/${self}/games2/steam" \
  "$@" || exit 1
exit 0
