#!/bin/sh

# DisplayPort monitor sometimes does not turn back on upon resume
# Poke it via xrandr to see if it will re-activate willingly.
#
# https://wiki.archlinux.org/title/Xrandr_

if [ "$(id -u)" -eq 0 ]; then
  printf -- 'You must run this script as your normal user, not root!\n'
  exit 1
fi

# Make an assumption about our Xorg environment
readonly XAUTHORITY="${HOME}/.Xauthority"
export XAUTHORITY

# Wait between pokes
readonly WAIT_TIME=1

##
# Poke with display
poke()
{
  _display="$1"

  # Guess DISPLAY variable to poke
  DISPLAY="${_display}"
  export DISPLAY

  # Attempt countdown
  count=2

  printf -- 'Attempting to poke monitor via xrandr.\n'
  while [ "${count}" -gt 0 ]; do
    printf -- 'Poke: %s...\n' "${count}"
    xrandr > /dev/null || {
      printf -- 'Failed to poke monitors with xrandr.\n'

      unset DISPLAY
      unset _display
      return 1
    }
    sleep "${WAIT_TIME}"
    count=$((count - 1))
  done

  printf -- 'Monitor has been poked.\n'
  unset DISPLAY
  unset _display
  return 0
}

main()
{
  # Try poking common monitor DISPLAY connections

  # Raw console startx
  poke ":0" && return 0

  # GDM
  poke ":1" && return 0

  # LightDM
  poke ":7" && return 0

  # Nothing worked
  printf -- 'Failed all attempts to poke monitor\n'
  return 1
}

main "$@" || exit 1
exit 0

