#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="ddns"
IMAGE="docker.io/favonia/cloudflare-ddns"
TAG="1.15.1"

# IPv6 support
CONTAINER_NETWORK_IP6=1

_prep_mounts() {
  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  return 0
}

_check_user() {
  _require_nonroot || return 1

  _add_userns --user "$(id -u):$(id -g)"

  return 0
}

_prep_env() {
  # Cloudflare owns our records
  _add_env -e PROXIED=true
  return 0
}

_prep_network() {
  _network_isolate || return 1

  # Force the DNS resolvers in the container so that we can avoid DNS caching issues
  # when attempting DNS-01 challenges
  _add_network --dns="1.1.1.1"
  _add_network --dns="1.0.0.1"
  _add_network --dns="2606:4700:4700::1111"
  _add_network --dns="2606:4700:4700::1001"

  return 0
}

_finalize() {
  if _is_podman; then
    if ! _is_cmd_version_atleast 5.4; then
      # ddns requires podman 5.4 which for some reason is able to support resolving IPv6 from
      # the container network
      _elog 'Your %s version must be at least %s to run the %s container' "${CONTAINER_CMD}" 5.4 "${NAME}"
      return 1
    fi
  fi

  # Can run as read-only root
  _add_rc --read-only
}

main "$@" || exit 1
exit 0
