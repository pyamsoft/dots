#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="littlelink"
IMAGE="ghcr.io/techno-tim/littlelink-server"
TAG="latest"

CONTAINER_REQUIRE_INIT=1

_prep_mounts() {
  _mount_mkdir "${CONTAINER_RUNTIME_DIR}/${NAME}/data" || return 1

  return 0
}

_prep_env() {
  CONTAINER_ENV="${CONTAINER_ENV} -e META_INDEX_STATUS=noindex"
  CONTAINER_ENV="${CONTAINER_ENV} -e LANG=en"
  CONTAINER_ENV="${CONTAINER_ENV} -e THEME=Dark"
  CONTAINER_ENV="${CONTAINER_ENV} -e THEME_OS=true"

  return 0
}

_prep_network() {
  # Attach our isolated network
  #
  # We shouldn't need to care about source IP addresses here as this website is proxied through Cloudflare
  # so their protections should generally handle it. Plus there are no specific log drivers in Crowdsec that
  # need to read these logs to identify bad actors.
  _network_isolate || return 1

  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:8420:3000/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

_containerize() {
  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # You need to add a CUSTOM_BUTTON_* for each new link
  # All CUSTOM_BUTTON_* FIELDS REQUIRED

  # Don't quote so that if user is empty it still expands
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run --rm \
    --name "${NAME}" --hostname "${NAME}" \
    --security-opt no-new-privileges:true --cap-drop ALL \
    --pull=newer \
    --init \
    -e "CUSTOM_BUTTON_TEXT=${_CUSTOM_BUTTON_TEXT}" \
    -e "CUSTOM_BUTTON_ALT_TEXT=${_CUSTOM_BUTTON_ALT_TEXT}" \
    -e "CUSTOM_BUTTON_ICON=${_CUSTOM_BUTTON_ICON}" \
    -e "FOOTER=${_FOOTER}" \
    -e "META_DESCRIPTION=${_META_DESCRIPTION}" \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" "$@"
}

main "$@" || exit 1
exit 0
