#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

# Define a basename here, which will be re-evaluated later once a MODE is defined
BASENAME="gatus"
NAME="${BASENAME}"
IMAGE="docker.io/twinproduction/gatus"
TAG="v5.33.1"

# Pick name based on environment mode
case "${GATUS_MODE}" in
internal)
  NAME="${NAME}-internal"
  GATUS_PORT=11267
  ;;
external)
  NAME="${NAME}-external"
  GATUS_PORT=11268
  ;;
*)
  _log 'You must export the Gatus mode as "GATUS_MODE": "internal" "external"'
  exit 1
  ;;
esac

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1
  return 0
}

_prep_env() {
  CONTAINER_ENV="${CONTAINER_ENV} -e GATUS_CONFIG_PATH=/config"
  return 0
}

_prep_network() {
  # Attach our isolated network
  #
  # We shouldn't need to care about source IP addresses here as this website is proxied through Cloudflare
  # so their protections should generally handle it. Plus there are no specific log drivers in Crowdsec that
  # need to read these logs to identify bad actors.
  _network_isolate || return 1

  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:${GATUS_PORT}:8080/tcp"
  return 0
}

_check_user() {
  if [ "$(id -u)" -eq 0 ]; then
    _log 'You must run this as a rootless container'
    return 1
  fi

  # Only for podman
  if _is_podman; then
    # Need this userns option that is podman specific or we have random OCI permission error
    CONTAINER_USERNS="${CONTAINER_USERNS} --userns keep-id"
  fi

  return 0
}

main "$@" || exit 1
exit 0
