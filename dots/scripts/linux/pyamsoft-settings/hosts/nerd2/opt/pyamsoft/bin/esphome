#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="esphome"
IMAGE="ghcr.io/esphome/esphome"
TAG="2026.1.1"

# default is fine unless you are compiling, then you need 8g lol
CONTAINER_MEMORY_LIMIT="8G"
CONTAINER_REQUIRE_RUNCONF=0

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/cache" "/cache" || return 1

  # For building
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/root" "/root" || return 1

  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:6052:6052/tcp"

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # Piggyback onto the home-assistant network
  _add_network --network "container:home-assistant"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Can run as read-only root
  _add_rc --read-only

  return 0
}

main "$@" || exit 1
exit 0
