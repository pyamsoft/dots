#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="zigbee2mqtt"
IMAGE="ghcr.io/koenkk/zigbee2mqtt"
TAG="2.7.2"

CONTAINER_MEMORY_LIMIT="128M"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/app/data" || return 1

  # Needs udev from host
  CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=/run/udev,target=/run/udev,ro"

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # Piggyback onto the home-assistant network
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=container:home-assistant"
  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:8080:8080/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  if _is_podman; then
    # Need this userns option that is podman specific or we have random OCI permission error
    CONTAINER_USERNS="${CONTAINER_USERNS} --userns keep-id"
    CONTAINER_USERNS="${CONTAINER_USERNS} --group-add keep-groups"
  fi

  return 0
}

main "$@" || exit 1
exit 0
