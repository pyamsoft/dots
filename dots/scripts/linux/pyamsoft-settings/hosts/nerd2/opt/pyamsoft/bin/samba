#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="samba"
IMAGE="docker.io/dockurr/samba"
TAG="4.22.6"

CONTAINER_MEMORY_LIMIT="128M"

_prep_mounts() {
  # Share folders are optionally symlinks to another mass storage drive
  _share="${CONTAINER_RUNTIME_DIR}/${NAME}/share"
  _host_mkdir "${_share}"

  # Follow the link and mount the share folder ONLY if it is valid
  if [ -d "$(realpath "${_share}")" ]; then
    _mount_bind "${_share}" "/storage" || return 1

    # You must manage the directory chmod yourself on the host
    # _host_chmod "g+rwX" "${_media}" || return 1
  fi
  unset _share

  # Custom samba config override
  _override="${CONTAINER_RUNTIME_DIR}/${NAME}/smb.conf"
  if [ -f "$(realpath "${_override}")" ]; then
    _add_mounts --mount "type=bind,src=${_override},target=/etc/samba/smb.conf" || return 1

    # Mark the smb.conf group access
    _host_chmod "g+rwX" "${_override}" || return 1
  fi
  unset _override

  return 0
}

_prep_caps() {
  # s6-init uses chown and drops privilege
  _add_caps --cap-add CHOWN
  _add_caps --cap-add SETGID
  _add_caps --cap-add SETUID
  _add_caps --cap-add KILL

  # Server runs on port 445 internally
  _add_caps --cap-add NET_BIND_SERVICE

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  # Host networking or else Samba drops Tailscale connections?
  _add_network --network="host"
  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:1445:445/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  _add_userns --user="0:0"
  if _is_podman; then
    # Need this userns option that is podman specific or we have random OCI permission error
    _add_userns --userns keep-id
    _add_userns --group-add keep-groups
  fi

  # Cannot safely run as read-only because it runs samba setup as root and writes to /etc
  # _add_rc --read-only

  return 0
}

main "$@" || exit 1
exit 0
