#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="samba"
IMAGE="docker.io/dockurr/samba"
TAG="4.22.6"

CONTAINER_MEMORY_LIMIT="128M"

_prep_mounts() {
  # Share folders are optionally symlinks to another mass storage drive
  _share="${CONTAINER_RUNTIME_DIR}/${NAME}/share"
  _mount_mkdir "${_share}"

  # Follow the link and mount the share folder ONLY if it is valid
  if [ -d "$(realpath "${_share}")" ]; then
    CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=${_share},target=/storage"
  fi
  unset _share

  # Custom samba config override
  _override="${CONTAINER_RUNTIME_DIR}/${NAME}/smb.conf"
  if [ -f "$(realpath "${_override}")" ]; then
    CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=${_override},target=/etc/samba/smb.conf"
  fi
  unset _override

  readonly _mounts
  return 0
}

_prep_caps() {
  # s6-init uses chown and drops privilege
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add CHOWN"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETGID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETUID"

  # Needed right after startup to open samba /cron/lock
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add FOWNER"

  # Server runs on port 137-139 and 445
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add NET_BIND_SERVICE"

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  # Host networking or else Samba drops Tailscale connections?
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=host"
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:1445:445/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

main "$@" || exit 1
exit 0
