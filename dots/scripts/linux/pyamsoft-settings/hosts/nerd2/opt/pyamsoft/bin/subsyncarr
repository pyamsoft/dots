#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="subsyncarr"
IMAGE="docker.io/mrorbitman/subsyncarr"
TAG="0.0.8"

CONTAINER_REQUIRE_INIT=1

_prep_mounts() {
  _media="${CONTAINER_RUNTIME_DIR}/${NAME}/media"

  # Media folders are optionally symlinks to another mass storage drive
  _mount_mkdir "${_media}"

  # Follow the link and mount the media folder ONLY if it is valid
  if [ -d "$(realpath "${_media}")" ] && [ -e "$(realpath "${_media}/mounted")" ]; then
    CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=${_media},target=/scan_dir/1"
  fi
  unset _media

  return 0
}

_prep_caps() {
  # Allow writing SRT files to output location
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add FOWNER"

  return 0
}

_prep_ports() {
  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_check_user() {
  if [ "$(id -u)" -eq 0 ]; then
    _log 'You must run this as a rootless container'
    return 1
  fi

  CONTAINER_USERNS="${CONTAINER_USERNS} --user=0:0"

  return 0
}

main "$@" || exit 1
exit 0
