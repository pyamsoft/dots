#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="subsyncarr"
IMAGE="docker.io/mrorbitman/subsyncarr"
TAG="0.0.8"

CONTAINER_REQUIRE_INIT=1

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/logs" "/app/logs" || return 1

  _media="${CONTAINER_RUNTIME_DIR}/${NAME}/media"

  # Media folders are optionally symlinks to another mass storage drive
  _mount_mkdir "${_media}"

  # Follow the link and mount the media folder ONLY if it is valid
  if [ -d "$(realpath "${_media}")" ] && [ -e "$(realpath "${_media}/mounted")" ]; then
    _mount_bind "${_media}" "/scan_dir" || return 1

    # You must manage the directory chmod yourself on the host
    # _host_chmod "g+rwX" "${_media}" || return 1
  fi
  unset _media

  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  return 0
}

_prep_env() {
  # Exclude currently downloading
  _add_env -e EXCLUDE_PATHS="/scan_dir/Downloads"

  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Only for podman
  if _is_podman; then
    _add_userns --userns keep-id
    _add_userns --group-add keep-groups
  fi

  # Can run as read-only root
  _add_rc --read-only

  return 0
}

main "$@" || exit 1
exit 0
