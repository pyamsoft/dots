#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="mosquitto"
IMAGE="docker.io/library/eclipse-mosquitto"
TAG="2.0.22"

CONTAINER_REQUIRE_RUNCONF=0

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/mosquitto/config" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/mosquitto/data" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/log" "/mosquitto/log" || return 1

  return 0
}

_prep_caps() {
  # Needed for s6
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add CHOWN"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETGID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETUID"
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:1883:1883/tcp"
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:9001:9001/tcp"
  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # Piggyback onto the home-assistant network
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=container:home-assistant"
  return 0
}

_check_user() {
  if [ "$(id -u)" -eq 0 ]; then
    _log 'You must run this as a rootless container'
    return 1
  fi

  # Run as root for s6
  CONTAINER_USERNS="--user=0:0"

  return 0
}

main "$@" || exit 1
exit 0
