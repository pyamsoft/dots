#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="whisper"
IMAGE="docker.io/homeassistant/amd64-addon-whisper"
TAG="3.0.1"

CONTAINER_REQUIRE_RUNCONF=0

# Allow model customization via variable or fallback to medium-int8
MODEL="${MODEL:-medium-int8}"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/data" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/download" "/download" || return 1
  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # Piggyback onto the home-assistant network
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=container:home-assistant"
  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:10300:10300/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

_containerize() {
  # Wake word command
  _wp_cmd="-m wyoming_faster_whisper"
  _wp_cmd="${_wp_cmd} --uri tcp://0.0.0.0:10300"
  _wp_cmd="${_wp_cmd} --model ${MODEL}"
  _wp_cmd="${_wp_cmd} --beam-size 1"
  _wp_cmd="${_wp_cmd} --compute-type int8"
  _wp_cmd="${_wp_cmd} --language en"
  _wp_cmd="${_wp_cmd} --data-dir /data"
  _wp_cmd="${_wp_cmd} --download-dir /download"

  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # Don't quote so that if user is empty it still expands
  #
  # Instead of running with privileged, you should pass devices in
  # via runconfig
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run --rm \
    --name "${NAME}" --hostname "${NAME}" \
    --security-opt no-new-privileges:true --cap-drop ALL \
    --entrypoint python3 \
    --init \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" \
    ${_wp_cmd} "$@"
}

main "$@" || exit 1
exit 0
