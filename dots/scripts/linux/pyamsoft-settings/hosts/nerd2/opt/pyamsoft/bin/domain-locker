#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="domain-locker"
IMAGE="docker.io/lissy93/domain-locker"
TAG="latest"

# The name of the postgres container we are attaching to
# or "postgres" if none provided
#
# This way we can support multiple instances of postgres running at
# a time.
POSTGRES_CONTAINER="${POSTGRES_CONTAINER:-postgres}"

CONTAINER_REQUIRE_RUNCONF=0

_prep_mounts() {
  return 0
}

_prep_caps() {
  return 0
}

_prep_env() {
  _add_env -e DL_ENV_TYPE="selfHosted"
  _add_env -e DL_PG_HOST="127.0.0.1"
  _add_env -e DL_PG_PORT=5432
  _add_env -e DL_PG_USER="domain-locker"
  _add_env -e DL_PG_PASSWORD="domain-locker"
  _add_env -e DL_PG_NAME="domain-locker"

  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # So we can talk to the postgres DB via localhost ports
  _add_network --network="container:${POSTGRES_CONTAINER}"
  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:5293:3000/tcp"
  return 0
}

_finalize() {
  # Can run as read-only root
  _add_rc --read-only

  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Only for podman
  if _is_podman; then
    # Otherwise we keep OCI
    _add_userns --userns keep-id
  fi

  return 0
}

main "$@" || exit 1
exit 0
