#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="unmanic"
IMAGE="docker.io/josh5/unmanic"
TAG="0.3.0"

CONTAINER_REQUIRE_RUNCONF=0

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/cache" "/tmp/unmanic" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1

  _media="${CONTAINER_RUNTIME_DIR}/${NAME}/media"

  # Media folders are optionally symlinks to another mass storage drive
  _mount_mkdir "${_media}"

  # Follow the link and mount the media folder ONLY if it is valid
  if [ -d "$(realpath "${_media}")" ]; then
    CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=${_media},target=/library"
  fi
  unset _media

  return 0
}

_get_gid_for_group() {
  _grp="$1"
  _gid="$(getent group "${_grp}" | cut -d : -f 3)"

  printf -- '%s' "${_gid}"

  unset _grp
  unset _gid
  return 0
}

_prep_env() {
  # Needed for GPU rendering
  CONTAINER_ENV="${CONTAINER_ENV} --group-add=$(_get_gid_for_group "render")"
  CONTAINER_ENV="${CONTAINER_ENV} --group-add=$(_get_gid_for_group "video")"
  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_prep_caps() {
  # s6-init uses chown and drops privilege
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add CHOWN"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETGID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETUID"

  # Needed to chown files during startup and execute start script
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add FOWNER"

  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:8888:8888/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Run as root or else s6 wont work
  # Need this userns option that is podman specific or we have random OCI permission error
  # Then drop to PUID and PGID permission that owns the media folder
  # Only for podman
  CONTAINER_USERNS="${CONTAINER_USERNS} --user=0:0 -e PUID=$(id -u) -e PGID=$(id -g)"
  if _is_podman; then
    CONTAINER_USERNS="${CONTAINER_USERNS} --userns keep-id"
  fi

  return 0
}

_containerize() {
  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # Don't quote so that if user is empty it still expands
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run --rm \
    --name "${NAME}" --hostname "${NAME}" \
    --security-opt no-new-privileges:true --cap-drop ALL \
    --device "/dev/dri:/dev/dri" \
    ${CONTAINER_MEMORY} \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" "$@"
}

main "$@" || exit 1
exit 0
