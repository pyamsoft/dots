#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="unmanic"
IMAGE="docker.io/josh5/unmanic"
TAG="0.3.0"

CONTAINER_REQUIRE_RUNCONF=0

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/cache" "/tmp/unmanic" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1

  _media="${CONTAINER_RUNTIME_DIR}/${NAME}/media"

  # Media folders are optionally symlinks to another mass storage drive
  _mount_mkdir "${_media}"

  # Follow the link and mount the media folder ONLY if it is valid
  if [ -d "$(realpath "${_media}")" ]; then
    _mount_bind "${_media}" "/library" || return 1
  fi
  unset _media

  return 0
}

_get_gid_for_group() {
  _grp="$1"
  _gid="$(getent group "${_grp}" | cut -d : -f 3)"

  printf -- '%s' "${_gid}"

  unset _grp
  unset _gid
  return 0
}

_prep_env() {
  _add_env -e PUID="$(id -u)"
  _add_env -e PGID="$(id -g)"
  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_prep_caps() {
  # s6-init uses chown and drops privilege
  _add_caps --cap-add CHOWN
  _add_caps --cap-add SETGID
  _add_caps --cap-add SETUID

  # Needed to chown files during startup and execute start script
  _add_caps --cap-add DAC_OVERRIDE
  _add_caps --cap-add FOWNER

  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:8888:8888/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Run as root or else s6 wont work
  # Need this userns option that is podman specific or we have random OCI permission error
  # Then drop to PUID and PGID permission that owns the media folder
  # Only for podman
  _add_userns --user="0:0"
  if _is_podman; then
    _add_userns --userns keep-id
  fi

  return 0
}

_finalize() {
  # Needed for GPU rendering
  _add_rc --device "/dev/dri:/dev/dri"
  _add_rc "--group-add=$(_get_gid_for_group "render")"
  _add_rc "--group-add=$(_get_gid_for_group "video")"
  return 0
}

main "$@" || exit 1
exit 0
