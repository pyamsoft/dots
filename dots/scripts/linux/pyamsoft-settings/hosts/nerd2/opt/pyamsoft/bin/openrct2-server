#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="openrct2-server"
IMAGE="localhost/pyamsoft/openrct2"
TAG="latest" # built from 0.4.7

CONTAINER_REQUIRE_INIT=1

readonly _save_game_root="${CONTAINER_RUNTIME_DIR}/${NAME}/config"

# OpenRCT2 runtime config variable
password=""
park="$1"

_prep_mounts() {
  # Park/saves must be in ${_mount1}/save/
  _mount_bind "${_save_game_root}" "/home/openrct2/.config/OpenRCT2" || return 1

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  # We continue using the DEFAULT network instead of creating our own.
  # The default network uses the a special setup of the bridge driver
  # which preserves source IP addresses
  #
  # We need to preserve source IP address so that Crowdsec can operate on bad actors
  #
  # However as a trade off, since this runs on the default bridge this decreases network isolation.
  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  # Openrct2 only uses TCP. I know. Wow
  _add_ports "-p 127.0.0.1:11753:11753/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Run as "our user" in the container instead of openrct2
  _add_userns "--user=$(id -u):$(id -g)"

  if _is_podman; then
    _add_userns "--userns keep-id"
  fi

  return 0
}

_finalize() {
  if [ -z "${password}" ]; then
    _log 'Must provide a server password via the "password" variable in %s' "${_runconf}"
    return 1
  fi

  return 0
}

_containerize() {
  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # Don't quote so that if user is empty it still expands
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run --rm \
    --name "${NAME}" --hostname "${NAME}" \
    --security-opt=no-new-privileges:true \
    --cap-drop=ALL \
    --pull=newer \
    --init \
    ${CONTAINER_MEMORY} \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" \
    ${CONTAINER_ARGS} \
    host \
    "/home/openrct2/.config/OpenRCT2/${park}" \
    --password \
    "${password}" \
    --headless \
    "$@"
}

if [ -z "${park}" ]; then
  _log 'Pass a path to an OpenRCT2 save game in root: %s.' "${_save_game_root}"
  exit 1
fi
shift

# Correct the path if it is absolute
# Corrects something like ${HOME}/games/openrct2/save/Park.park => save/Park.park
park="${park#*/openrct2-server/config/}"

main "$@" || exit 1
exit 0
