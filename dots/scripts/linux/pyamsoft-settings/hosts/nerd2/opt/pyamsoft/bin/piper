#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="piper"
IMAGE="docker.io/homeassistant/amd64-addon-piper"
TAG="2.1.1"

CONTAINER_REQUIRE_RUNCONF=0
CONTAINER_REQUIRE_INIT=1
CONTAINER_ENTRYPOINT="python3"

# Allow model customization via variable or fallback to "Lessac Medium"
MODEL="${MODEL:-en_US-lessac-medium}"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/data" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/download" "/download" || return 1

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # Piggyback onto the home-assistant network
  _add_network --network="container:home-assistant"
  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:10200:10200/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

_finalize() {
  # Wake word command
  _add_args -m "wyoming_piper"
  _add_args --uri "tcp://0.0.0.0:10200"
  _add_args --length-scale 1
  _add_args --noise-scale 0.667
  _add_args --speaker 0
  _add_args --voice "${MODEL}"
  _add_args --data-dir "/data"
  _add_args --download-dir "/download"

  # Make sure home assistant is alive
  _add_rc --requires "home-assistant"

  return 0
}

main "$@" || exit 1
exit 0
