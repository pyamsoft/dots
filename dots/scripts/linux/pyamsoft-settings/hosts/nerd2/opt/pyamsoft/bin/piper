#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="piper"
IMAGE="docker.io/homeassistant/amd64-addon-piper"
TAG="2.1.1"

CONTAINER_REQUIRE_RUNCONF=0

# Allow model customization via variable or fallback to "Lessac Medium"
MODEL="${MODEL:-en_US-lessac-medium}"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/data" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/download" "/download" || return 1

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # Piggyback onto the home-assistant network
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=container:home-assistant"
  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:10200:10200/tcp"
  return 0
}

_check_user() {
  if [ "$(id -u)" -eq 0 ]; then
    _log 'You must run this as a rootless container'
    return 1
  fi

  return 0
}

_containerize() {
  # Wake word command
  _pp_cmd="-m wyoming_piper"
  _pp_cmd="${_pp_cmd} --uri tcp://0.0.0.0:10200"
  _pp_cmd="${_pp_cmd} --length-scale 1"
  _pp_cmd="${_pp_cmd} --noise-scale 0.667"
  _pp_cmd="${_pp_cmd} --speaker 0"
  _pp_cmd="${_pp_cmd} --voice ${MODEL}"
  _pp_cmd="${_pp_cmd} --data-dir /data"
  _pp_cmd="${_pp_cmd} --download-dir /download"

  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # Don't quote so that if user is empty it still expands
  #
  # Instead of running with privileged, you should pass devices in
  # via runconfig
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run --rm \
    --name "${NAME}" --hostname "${NAME}" \
    --security-opt no-new-privileges:true --cap-drop ALL \
    --entrypoint python3 \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" \
    ${_pp_cmd} "$@"
}

main "$@" || exit 1
exit 0
