#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="openwakeword"
IMAGE="docker.io/homeassistant/amd64-addon-openwakeword"
TAG="2.1.0"

CONTAINER_REQUIRE_RUNCONF=0

# Allow model customization via variable or fallback to "Hey Jarvis"
MODEL="${MODEL:-hey_jarvis}"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/models" "/custom-model" || return 1

  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:10400:10400/tcp"
  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # Piggyback onto the home-assistant network
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=container:home-assistant"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

_containerize() {
  # Wake word command
  _oww_cmd="-m wyoming_openwakeword"
  _oww_cmd="${_oww_cmd} --uri tcp://0.0.0.0:10400"
  _oww_cmd="${_oww_cmd} --preload-model ${MODEL}"
  _oww_cmd="${_oww_cmd} --custom-model-dir /custom-model"

  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # Don't quote so that if user is empty it still expands
  #
  # Instead of running with privileged, you should pass devices in
  # via runconfig
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run --rm \
    --name "${NAME}" --hostname "${NAME}" \
    --security-opt no-new-privileges:true --cap-drop ALL \
    --entrypoint python3 \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" \
    ${_oww_cmd} "$@"
}

main "$@" || exit 1
exit 0
