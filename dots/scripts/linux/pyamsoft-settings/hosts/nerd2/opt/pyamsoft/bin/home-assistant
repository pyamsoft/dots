#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="home-assistant"
IMAGE="ghcr.io/linuxserver/homeassistant"
TAG="2025.12.5"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/data" || return 1

  # DBUS access for bluetooth
  CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=/run/dbus,target=/run/dbus,ro"

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  # Host networking for SSDP and mDNS
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=host"
  return 0
}

_prep_caps() {
  # Needed for s6
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add CHOWN"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETGID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETUID"

  # For bluetooth
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add NET_RAW"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add NET_ADMIN"

  return 0
}

_prep_ports() {
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Ok so what the hell is this
  # well, we need keep-id to use bluetooth in the container
  # but we also need s6 to run as root, so we declare the main user as root
  CONTAINER_USERNS="${CONTAINER_USERNS} -e PUID=$(id -u) -e PGID=$(id -g) --user=0:0"

  if _is_podman; then
    # Need this userns option that is podman specific or we have random OCI permission error
    CONTAINER_USERNS="${CONTAINER_USERNS} --userns keep-id"
  fi

  return 0
}

main "$@" || exit 1
exit 0
