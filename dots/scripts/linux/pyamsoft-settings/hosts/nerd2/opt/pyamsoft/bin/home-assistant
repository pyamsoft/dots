#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="home-assistant"
IMAGE="ghcr.io/linuxserver/homeassistant"
TAG="2026.1.3"

CONTAINER_MEMORY_LIMIT="4G"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1
  _host_chmod "g+rwX" "${CONTAINER_RUNTIME_DIR}/${NAME}/config" || return 1

  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/data" || return 1
  _host_chmod "g+rwX" "${CONTAINER_RUNTIME_DIR}/${NAME}/data" || return 1

  # DBUS access for bluetooth
  _mount_bind "/run/dbus" "/run/dbus" "ro" || return 1

  return 0
}

_prep_env() {
  _add_env -e PUID="$(id -u)"
  _add_env -e PGID="$(id -g)"
  return 0
}

_prep_network() {
  # Host networking for SSDP and mDNS
  _add_network --network="host"
  return 0
}

_prep_caps() {
  # Needed for s6
  _add_caps --cap-add CHOWN
  _add_caps --cap-add SETGID
  _add_caps --cap-add SETUID

  # For bluetooth
  _add_caps --cap-add NET_RAW
  _add_caps --cap-add NET_ADMIN

  # Complains about missing this cap, but when we add it
  # it loops forever on a fail because of no-new-privileges
  # unable to set CAP_SETFCAP effective capability: Operation not permitted

  return 0
}

_prep_ports() {
  return 0
}

_check_user() {
  _require_nonroot || return 1

  _add_userns --user="0:0"
  if _is_podman; then
    # Need this userns option that is podman specific or we have random OCI permission error
    _add_userns --userns keep-id
    _add_userns --group-add keep-groups
  fi

  # Cannot safely run as read-only because of setcap call for bluetooth
  # even though that call fails
  #
  # if it fails because of permission denied instead of Operation not permitted, it loops forever
  # _add_rc --read-only

  return 0
}

main "$@" || exit 1
exit 0
