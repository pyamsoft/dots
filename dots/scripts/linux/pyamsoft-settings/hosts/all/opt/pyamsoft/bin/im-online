#!/bin/sh

PROG="$(basename "$0")"
readonly PROG

# Checks that NetworkManager is alive
# Checks that NetworkManager is online
# Checks that ping works on Google without DNS (8.8.8.8)
# Checks that ping works on Google with DNS (google.com)

# Max time to wait for backoff
readonly BACKOFF_LIMIT_S=30

_log() {
  _msg="$1"
  shift

  printf -- "[%s]: ${_msg}\n" "${PROG}" "$@" || return 1

  unset _msg
  return 0
}

##
# Log a message to stderr
_elog() {
  _log "$@" 1>&2 || return 1
  return 0
}

_nm_online() {
  # nm-online is optional, only used for systems that use NetworkManager
  if ! command -v nm-online >/dev/null; then
    return 0
  fi

  # Run nm-online
  _backoff=1
  while ! nm-online -q -t "${_backoff}" "$1" >/dev/null 2>&1; do
    if [ "${_backoff}" -gt "${BACKOFF_LIMIT_S}" ]; then
      return 1
    fi

    # Ping failed, wait for backoff time and try again
    sleep "${_backoff}"
    _backoff="$((_backoff * 2))"
  done

  return 0
}

_check_nm_alive() {
  _nm_online -s || return 1
  return 0
}

_check_nm_online() {
  _nm_online || return 1
  return 0
}

_ping() {
  if ! command -v ping >/dev/null; then
    _elog 'Missing "ping", cannot run check'
    return 1
  fi

  _backoff=1
  while ! ping -c 1 -n "$1" >/dev/null 2>&1; do
    if [ "${_backoff}" -gt "${BACKOFF_LIMIT_S}" ]; then
      return 1
    fi

    # Ping failed, wait for backoff time and try again
    sleep "${_backoff}"
    _backoff="$((_backoff * 2))"
  done

  return 0
}

_ping_google_ip() {
  _ping "8.8.8.8" || return 1
  return 0
}

_ping_google_dns() {
  _ping "google.com" || return 1
  return 0
}

main() {
  _check_nm_alive || {
    _elog 'NetworkManager is dead. NOT ONLINE'
    return 1
  }

  _check_nm_online || {
    _elog 'NetworkManager is offline. NOT ONLINE'
    return 2
  }

  _ping_google_ip || {
    _elog 'Could not ping Google IP. NOT ONLINE'
    return 3
  }

  # Optionally check that we have DNS
  case "$1" in
  d | dns | -d | --dns)
    _ping_google_dns || {
      _elog 'Could not ping Google DNS. NOT ONLINE'
      return 4
    }
    ;;
  esac

  _log 'NETWORK ONLINE'
  return 0
}

main "$@" || exit 1
exit 0
