#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

# Define a basename here, which will be re-evaluated later once a MODE is defined
BASENAME="beszel"
NAME="${BASENAME}"
TAG="0.17.0"

CONTAINER_MEMORY_LIMIT="64M"

# The SSH key used by hub and agents to auth each other
BESZEL_KEY=""

##
# hub - the Beszel hub
# agent - Agent instance running on the same machine as the hub
#   - Requires runconfig.env to contain [TOKEN and HUB_URL] or [LISTEN]
# remote - Agent instance running on a different machine than the hub
#   - Requires runconfig.env to contain [TOKEN and HUB_URL] and export [BESZEL_KEY]
case "${BESZEL_MODE}" in
hub | agent | remote) ;;
*)
  _log 'Must run with BESZEL_MODE set to one of "agent" "hub" "remote"'
  exit 1
  ;;
esac

# Now define the real name since we have an operating mode
NAME="${NAME}-${BESZEL_MODE}"
if [ "${BESZEL_MODE}" = "hub" ]; then
  IMAGE="docker.io/henrygd/beszel"
else
  IMAGE="docker.io/henrygd/beszel-agent"
  # -alpine supports SMART data
  TAG="${TAG}-alpine"
fi

_prep_ssh_key() {
  _data_dir="$1"

  if [ "${BESZEL_MODE}" = "agent" ]; then
    # Read the SSH pubkey
    if [ -d "${_data_dir}" ] && [ -e "${_data_dir}/id_ed25519.pub" ]; then
      BESZEL_KEY="$(awk '{ print $1 " " $2 }' <"${_data_dir}/id_ed25519.pub")"
      export BESZEL_KEY
    fi
  else
    # Create the private SSH key if it does not already exist
    if [ ! -e "${_data_dir}/id_ed25519" ]; then
      ssh-keygen -q -N "" -C "" -t ed25519 -f "${_data_dir}/id_ed25519" || {
        _log 'Failed to generate private SSH key'
        return 1
      }
    fi

    # Create the public SSH key if it does not already exist
    if [ ! -e "${_data_dir}/id_ed25519.pub" ]; then
      ssh-keygen -q -N "" -C "" -y -f "${_data_dir}/id_ed25519" || {
        _log 'Failed to generate public SSH key'
        return 1
      }
    fi
  fi

  unset _data_dir
  return 0
}

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/beszel_data" || return 1

  if [ "${BESZEL_MODE}" != "remote" ]; then
    _hub_data="${CONTAINER_RUNTIME_DIR}/${BASENAME}-hub/data"

    if [ "${BESZEL_MODE}" = "hub" ]; then
      _mount_mkdir "${_hub_data}" || return 1
    fi

    _prep_ssh_key "${_hub_data}" || return 1
    unset _hub_data
  fi
  return 0
}

_prep_caps() {
  if [ "${BESZEL_MODE}" != "hub" ]; then
    # For reading SMART data with smartctl
    _add_caps --cap-add SYS_RAWIO

    # For reading NVME data
    _add_caps --cap-add SYS_ADMIN
  fi

  return 0
}

_prep_env() {
  _add_env -e DATA_DIR="/beszel_data"

  return 0
}

_prep_network() {
  if [ "${BESZEL_MODE}" = "hub" ]; then
    _network_isolate "${BASENAME}" || return 1
  else
    # Agent must run with host networking
    _add_network --network="host"
  fi

  return 0
}

_prep_ports() {
  if [ "${BESZEL_MODE}" = "hub" ]; then
    _add_ports -p "127.0.0.1:8090:8090/tcp"
  fi

  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Only for podman
  if _is_podman; then
    # Need this userns option that is podman specific or we have random OCI permission error
    _add_userns --userns keep-id
  fi

  return 0
}

_finalize() {
  if [ "${BESZEL_MODE}" = "hub" ]; then
    _log 'Beszel Hub creates its own SSH key that agents must use.'

    # Can continue with blank key, it's ignored in hub mode
  else
    if [ -z "${BESZEL_KEY}" ]; then
      _log 'You must export the Beszel Hub SSH public key as "BESZEL_KEY"'
      _log 'This ssh public key MUST be the same as the one in the beszel-hub data directory.'

      return 1
    fi
  fi

  return 0
}

_containerize() {
  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # Don't quote so that if user is empty it still expands
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run \
    --rm \
    --name="${NAME}" \
    --hostname="${NAME}" \
    --security-opt=no-new-privileges:true \
    --cap-drop=ALL \
    -e "KEY=${BESZEL_KEY}" \
    ${CONTAINER_MEMORY} \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" \
    ${CONTAINER_ARGS} \
    "$@"
}

main "$@" || exit 1
exit 0
