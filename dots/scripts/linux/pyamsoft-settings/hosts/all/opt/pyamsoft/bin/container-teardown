#!/bin/sh

readonly _PROG="container-teardown"
readonly _DEFAULT_TIME=5

_log() {
  _msg="$1"
  shift

  printf -- "[%s]: ${_msg}\n" "${_PROG}" "$@" || return 1

  unset _msg
  return 0
}

# Use podman, don't use docker
if command -v podman >/dev/null; then
  _cmd="podman"
elif command -v docker >/dev/null; then
  _cmd="docker"
else
  _log 'Requires either "podman" or "docker" ("podman" preferred)'
  exit 1
fi
readonly _cmd

_usage() {
  _log '%s' "$(
    cat <<EOF

${_PROG} [option(s)] [--] <name(s)> 

<name>                name of the container to teardown (one or more)
[-t|--time] <value>   time to wait for container to stop (default 5s)
--                    Stop processing options

Teardown will:

For normal scripts:
- Nicely attempt to stop container
  - If fails, forcibly stop container
- Nicely stop associated network if one exists
  - If fails, forcibly stop associated network if one exists

For compose:
- Nicely attempt to down a compose container, and remove orphan services

EOF
  )"
}

_teardown_container() {
  _container="$1"
  _teardown_time="$2"

  # Attempt nice stop
  _log 'Try nice stop container: %s (%ss)' "${_container}" "${_teardown_time}"
  "${_cmd}" stop -t "${_teardown_time}" "${_container}" >/dev/null 2>&1 || {
    _log 'Failed to nicely stop container %s (%ss)' "${_container}" "${_teardown_time}"
  }

  # Remove the container
  _log 'Try force-remove container: %s' "${_container}"
  "${_cmd}" rm -f "${_container}" >/dev/null 2>&1 || {
    _log 'Failed to force remove the container %s' "${_container}"

    # If this fails, we failed
    return 1
  }

  # Remove the network
  _log 'Try remove container network: %s (%ss)' "${_container}" "${_teardown_time}"
  if [ "${_cmd}" = "podman" ]; then
    "${_cmd}" network rm -f -t "${_teardown_time}" "${_container}" >/dev/null 2>&1 || {
      _log 'Failed to remove the container network: %s (%ss)' "${_container}" "${_teardown_time}"
    }
  else
    # Docker does not support -t flag for network rm
    "${_cmd}" network rm -f "${_container}" >/dev/null 2>&1 || {
      _log 'Failed to remove the container network: %s' "${_container}"
    }
  fi

  _log 'Container is completely torn down: %s' "${_container}"

  unset _teardown_time
  unset _container
  return 0
}

_is_compose() {
  _container="$1"

  if [ "$(id -u)" -eq 0 ]; then
    _compose_dir="/usr/local/etc/containers/${_container}"
  else
    _compose_dir="${HOME}/.local/etc/containers/${_container}"
  fi
  _compose_file="${_compose_dir}/compose.yml"

  # Check that the container location exists
  if [ ! -d "${_compose_dir}" ]; then
    return 1
  fi

  # Check that it's compose
  if [ ! -e "${_compose_file}" ]; then
    return 1
  fi

  return 0
}

_teardown_compose() {
  _container="$1"
  _teardown_time="$2"

  cd "${_compose_dir}" || {
    _log 'Failed to move into compose project: %s' "${_compose_dir}"
    return 1
  }

  _log 'Try bring down compose: %s' "${_container}"
  "${_cmd}" compose --file "${_compose_file}" down --remove-orphans -t "${_teardown_time}" >/dev/null 2>&1 || {
    _log 'Failed to bring down compose: %s' "${_container}"
    return 1
  }

  _log 'Compose is completely torn down: %s' "${_container}"

  unset _teardown_time
  return 0
}

main() {
  # Podman expects us to be in a accessible CWD
  cd "${HOME}" || {
    _log 'Unable to cd to user HOME for sanity'
    return 1
  }

  _time="${_DEFAULT_TIME}"
  _containers=""
  _no_more_options=0
  for _arg in "$@"; do
    if [ "${_no_more_options}" -eq 0 ]; then
      case "$1" in
      --time=*)
        _time="$(printf -- '%s' "$1" | tr '=' ' ' | awk '{ print $2 }')"

        # Did we pass an argument and is it a time
        if ! [ "${_time}" -eq "${_time}" ] >/dev/null 2>&1; then
          _log 'Unexpected "time" argument: "%s". Fallback to default: %ss' "${_time}" "${_DEFAULT_TIME}"
          _time="${_DEFAULT_TIME}"
        fi

        # Eat argument
        shift

        continue
        ;;
      -t | --time)
        # Eat this $1 so that we can process the passed in "time value"
        shift

        _time="$1"
        # Did we pass an argument and is it a time
        if ! [ "${_time}" -eq "${_time}" ] >/dev/null 2>&1; then
          _log 'Unexpected "time" argument: "%s". Fallback to default: %ss' "${_time}" "${_DEFAULT_TIME}"
          _time="${_DEFAULT_TIME}"
        fi

        # Eat time value
        shift

        continue
        ;;
      --)
        _no_more_options=1
        shift

        continue
        ;;
      *) ;;
      esac
    fi

    # Add to containers
    if [ -z "${_containers}" ]; then
      _containers="$1"
    else
      # Go in order
      _containers="${_containers} $1"
    fi

    if [ "$#" -gt 0 ]; then
      # Eat
      shift
    fi
    unset _arg
  done
  unset _arg

  if [ -z "${_containers}" ]; then
    _log 'Must provide at least one container name to teardown.'
    _usage || return 1
    return 1
  fi

  for _c in ${_containers}; do
    if _is_compose "${_c}"; then
      _log 'Attempting teardown of compose %s (%ss)' "${_c}" "${_time}"
      _teardown_compose "${_c}" "${_time}" || return 1
    else
      _log 'Attempting teardown of container %s (%ss)' "${_c}" "${_time}"
      _teardown_container "${_c}" "${_time}" || return 1
    fi

    unset _container
    unset _compose_dir
    unset _compose_file
    unset _c
  done
  unset _c

  # Done operation
  _log '---'

  unset _time
  unset _containers
  return 0
}

main "$@" || exit 1
exit 0
