#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="beets"
IMAGE="ghcr.io/linuxserver/beets"
TAG="2.5.1"

CONTAINER_REQUIRE_RUNCONF=0
CONTAINER_MEMORY_LIMIT="2G"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/downloads" "/downloads" || return 1

  _host_chmod "g+rwX" "${CONTAINER_RUNTIME_DIR}/${NAME}/config" || return 1
  _host_chmod "g+rwX" "${CONTAINER_RUNTIME_DIR}/${NAME}/downloads" || return 1

  # Media folders are optionally symlinks to another mass storage drive
  _media="${CONTAINER_RUNTIME_DIR}/${NAME}/media"
  _host_mkdir "${_media}"

  # Follow the link and mount the media folder ONLY if it is valid
  if [ -d "$(realpath "${_media}")" ]; then
    _mount_bind "${_media}" "/music" || return 1

    # You must manage the directory chmod yourself on the host
    # _host_chmod "g+rwX" "${_media}" || return 1
  fi

  unset _media

  return 0
}

_prep_env() {
  _add_env -e PUID="$(id -u)"
  _add_env -e PGID="$(id -g)"
  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_prep_caps() {
  # Needed for s6
  _add_caps --cap-add CHOWN
  _add_caps --cap-add SETGID
  _add_caps --cap-add SETUID
  _add_caps --cap-add KILL

  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:8337:8337/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  _add_userns --user="0:0"

  if _is_podman; then
    # Need this userns option that is podman specific or we have random OCI permission error
    _add_userns --userns keep-id
    _add_userns --group-add keep-groups
  fi

  return 0
}

main "$@" || exit 1
exit 0
