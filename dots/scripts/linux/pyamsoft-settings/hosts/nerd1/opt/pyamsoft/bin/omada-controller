#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="omada-controller"
IMAGE="docker.io/mbentley/omada-controller"
TAG="5.15.24.19"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/opt/tplink/EAPController/data" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/logs" "/opt/tplink/EAPController/logs" || return 1

  return 0
}

_prep_env() {
  # Environment to Port binding
  _add_env -e MANAGE_HTTP_PORT=8088
  _add_env -e MANAGE_HTTPS_PORT=8043
  _add_env -e PORTAL_HTTP_PORT=8088
  _add_env -e PORTAL_HTTPS_PORT=8843
  _add_env -e PORT_ADOPT_V1=29812
  _add_env -e PORT_APP_DISCOVERY=27001
  _add_env -e PORT_DISCOVERY=29810
  _add_env -e PORT_MANAGER_V1=29811
  _add_env -e PORT_MANAGER_V2=29814
  _add_env -e PORT_TRANSFER_V2=29815
  _add_env -e PORT_RTTY=29816
  _add_env -e PORT_UPGRADE_V1=29813

  _add_env -e SHOW_SERVER_LOGS=true
  _add_env -e SHOW_MONGODB_LOGS=false

  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_finalize() {
  # ULimit increase
  _add_rc --ulimit nofile="4096:8192"

  return 0
}

_prep_caps() {
  # Needed to write omada group to container groupfile
  _add_caps --cap-add SETGID
  _add_caps --cap-add SETUID

  # Drop priv and switch to omada user
  _add_caps --cap-add CHOWN

  # Won't be able to create the DB on first launch without this
  _add_caps --cap-add DAC_OVERRIDE

  return 0
}

_prep_ports() {
  # Bind to localhost (if you need other ports, use runconfig.env)
  _add_ports -p "127.0.0.1:8088:8088/tcp"
  _add_ports -p "127.0.0.1:8043:8043/tcp"
  _add_ports -p "127.0.0.1:8843:8843/tcp"
  _add_ports -p "127.0.0.1:27001:27001/udp"
  _add_ports -p "127.0.0.1:29810:29810/udp"
  _add_ports -p "127.0.0.1:29811-29816:29811-29816/tcp"

  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

main "$@" || exit 1
exit 0
