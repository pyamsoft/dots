#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="domain-locker"
IMAGE="docker.io/lissy93/domain-locker"
TAG="latest"

CONTAINER_REQUIRE_RUNCONF=0

_prep_mounts() {
  _add_env -e DL_ENV_TYPE="selfHosted"
  _add_env -e DL_PG_HOST="127.0.0.1"
  _add_env -e DL_PG_PORT=5432
  _add_env -e DL_PG_USER="domain-locker"
  _add_env -e DL_PG_PASSWORD="domain-locker"
  _add_env -e DL_PG_NAME="domain-locker"

  return 0
}

_prep_caps() {
  # s6
  # s6-init uses chown and drops privilege
  # _add_caps --cap-add CHOWN
  # _add_caps --cap-add SETGID
  # _add_caps --cap-add SETUID

  # Needed to chown files during startup and execute start script
  # _add_caps --cap-add DAC_OVERRIDE

  # To own /var/run/postgresql
  # _add_caps --cap-add FOWNER
  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  CONTAINER_NETWORK_HOST_ROUTE=0

  # So we can talk to the postgres DB via localhost ports
  _add_network --network="container:postgres"
  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:5293:3000/tcp"
  return 0
}

_finalize() {
  # Require the postgres container
  _add_rc --requires postgres
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Only for podman
  if _is_podman; then
    # Otherwise we keep OCI
    _add_userns --userns keep-id
  fi

  return 0
}

main "$@" || exit 1
exit 0
