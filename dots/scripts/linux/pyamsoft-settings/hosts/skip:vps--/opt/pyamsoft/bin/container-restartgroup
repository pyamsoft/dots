#!/bin/sh

PROG="$(basename "$0")"
readonly PROG

__containers_user=""
__network_owner=""
__running_containers=""

_log() {
  _msg="$1"
  shift

  printf -- "[%s]: ${_msg}\n" "${PROG}" "$@" || return 1

  unset _msg
  return 0
}

##
# Log a message to stderr
_elog() {
  _log "$@" 1>&2 || return 1
  return 0
}

_stop() {
  _log 'Stop container %s' "$1"
  "${__containers_user}" stop "$1" || {
    _elog 'Failed to stop container %s' "$1"
    return 1
  }

  return 0
}

_restart() {
  _log 'Restarting container %s' "$1"
  "${__containers_user}" restart "$1" || {
    _elog 'Failed to restart container %s' "$1"
    return 1
  }

  return 0
}

_collect_running() {
  for _container in $("${__containers_user}" ps --format '{{ .Names }}'); do
    if [ "${_container}" = "${__network_owner}" ]; then
      unset _container
      continue
    fi

    if [ -z "${__running_containers}" ]; then
      __running_containers="${_container}"
    else
      __running_containers="${_container} ${__running_containers}"
    fi
    unset _container
  done
  unset _container

  return 0
}

_restarthook() {
  _active_dependants=""

  for _dep in "$@"; do
    for _running in ${__running_containers}; do
      if [ "${_running}" = "${_dep}" ]; then
        if [ -z "${_active_dependants}" ]; then
          _active_dependants="${_dep}"
        else
          _active_dependants="${_dep} ${_active_dependants}"
        fi
        break
      fi
      unset _running
    done
    unset _running
    unset _dep
  done
  unset _dep

  if [ -n "${_active_dependants}" ]; then
    for _dep in ${_active_dependants}; do
      _stop "${_dep}"
      unset _dep
    done
    unset _dep

    _stop "${__network_owner}"
  fi

  _restart "${__network_owner}"

  for _dep in "$@"; do
    _restart "${_dep}"
    unset _dep
  done
  unset _dep

  unset _dependants
  unset _active_dependants

  return 0
}

main() {
  # Resolve the user
  __containers_user="$1"
  if [ -z "${__containers_user}" ]; then
    _elog 'Must specify a user to run script.'
    return 1
  fi

  if ! id -u "${__containers_user}" >/dev/null 2>&1; then
    _elog 'Must specify a valid user. Cannot continue with "%s"' "${__containers_user}"
    return 1
  fi

  # Eat the user argument
  shift

  # Resolve the network owner container
  __network_owner="$1"
  if [ -z "${__network_owner}" ]; then
    _elog 'Must specify a container group network-owner.'
    return 1
  fi

  # Eat network owner
  shift

  _collect_running || return 1
  _restarthook "$@" || return 1

  unset __containers_user
  unset __network_owner

  return 0
}

main "$@" || exit 1
exit 0
