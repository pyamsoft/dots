#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

# Since this container is more of a "library", we could potentially have many instances
# as such, we do NOT need to enforce a hard-set name. A caller could override this by passing NAME=
# themselves when invoking this script.
NAME="${NAME:-wireguard}"

IMAGE="docker.io/jordanpotter/wireguard"
TAG="2026-01-20"

CONTAINER_NETWORK_HOST_ROUTE=0

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/wg" "/etc/wireguard" || return 1

  # Bind kernel modules
  _mount_bind "/lib/modules" "/lib/modules" || return 1

  readonly _mounts
  return 0
}

_prep_caps() {
  # For networking and iptables
  _add_caps --cap-add NET_ADMIN
  _add_caps --cap-add NET_RAW

  # Optional only if WG module isn't loaded
  _add_caps --cap-add SYS_MODULE

  # Needs this for file access and config writing
  # _add_caps --cap-add CHOWN
  # _add_caps --cap-add DAC_OVERRIDE
  # _add_caps --cap-add SETGID
  # _add_caps --cap-add SETUID

  return 0
}

_prep_ports() {
  # Configure ports in the runconfig.env
  return 0
}

_prep_env() {
  _add_env -e PUID="$(id -u)"
  _add_env -e PGID="$(id -g)"
  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

_finalize() {
  _add_rc --sysctl="net.ipv4.conf.all.src_valid_mark=1"

  return 0
}

main "$@" || exit 1
exit 0
