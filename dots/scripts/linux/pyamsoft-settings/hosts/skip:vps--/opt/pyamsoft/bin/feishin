#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="feishin"
IMAGE="ghcr.io/jeffvli/feishin"
TAG="1.3.0"

CONTAINER_MEMORY_LIMIT="64M"
CONTAINER_NETWORK_HOST_ROUTE=0

_prep_mounts() {
  return 0
}

_prep_env() {
  _add_env -e SERVER_NAME="navidrome"
  _add_env -e SERVER_TYPE="navidrome"
  _add_env -e SERVER_LOCK=true

  _add_env -e PUID="$(id -u)"
  _add_env -e PGID="$(id -g)"

  readonly _env
  return 0
}

_prep_network() {
  # Piggyback onto the navidrome network
  _add_network --network="container:navidrome"
  return 0
}

_prep_caps() {
  # s6-init uses chown and drops privilege
  _add_caps --cap-add CHOWN
  _add_caps --cap-add SETGID
  _add_caps --cap-add SETUID

  # Needed to chown files during startup and execute start script
  _add_caps --cap-add DAC_OVERRIDE
  return 0
}

_prep_ports() {
  _add_ports -p "127.0.0.1:9180:9180/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

_finalize() {
  # Make sure the navidrome container is alive
  _add_rc --requires "navidrome"
}

main "$@" || exit 1
exit 0
