#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="unbound"
IMAGE="docker.io/madnuttah/unbound"
TAG="1.24.2-0"

CONTAINER_REQUIRE_RUNCONF=0

if _is_macos; then
  UNBOUND_DIR="${HOME}/.local/etc/${NAME}"
else
  UNBOUND_DIR="/etc/${NAME}"
fi
readonly UNBOUND_DIR

_prep_mounts() {
  # These are system level directories
  _mount_bind "${UNBOUND_DIR}/conf.d" "/usr/local/unbound/conf.d" || return 1
  _mount_bind "${UNBOUND_DIR}/zones.d" "/usr/local/unbound/zones.d" || return 1
  _mount_bind "${UNBOUND_DIR}/rpz.d" "/usr/local/unbound/rpz.d" || return 1

  # Use the host system root.key and hints on Linux, otherwise use the container
  if _is_linux; then
    _mount_bind "${UNBOUND_DIR}/iana.d" "/usr/local/unbound/iana.d" || return 1
  fi

  readonly _conf="${UNBOUND_DIR}/unbound.conf"

  if [ ! -r "${_conf}" ]; then
    _log 'Config must exist at %s' "${_conf}"
    return 1
  fi

  CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=${_conf},target=/usr/local/unbound/unbound.conf"

  return 0
}

_prep_env() {
  CONTAINER_ENV="${CONTAINER_ENV} -e UNBOUND_UID=$(id -u)"
  CONTAINER_ENV="${CONTAINER_ENV} -e UNBOUND_GID=$(id -g)"

  return 0
}

_prep_caps() {
  # Needed to setup permissions in the container
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETGID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETUID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"

  # To bind to port 53 in the container
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add NET_BIND_SERVICE"

  return 0
}

_prep_network() {
  _network_isolate || return 1

  # We are the DNS for this container
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --dns 127.0.0.1"

  return 0
}

_prep_ports() {
  # Bind a non-priv port on the host machine and forward the traffic into the container
  # Setup iptables forwarding to still use port 53 on the host
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:5335:53/tcp"
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:5335:53/udp"

  return 0
}

_check_user() {
  _require_nonroot || return 1

  if _is_podman; then
    CONTAINER_USERNS="${CONTAINER_USERNS} --userns keep-id"
  fi

  return 0
}

main "$@" || exit 1
exit 0
