#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="feishin"
IMAGE="ghcr.io/jeffvli/feishin"
TAG="1.2.0"

CONTAINER_NETWORK_HOST_ROUTE=0

_prep_mounts() {
  return 0
}

_prep_env() {
  CONTAINER_ENV="${CONTAINER_ENV} -e SERVER_NAME=navidrome"
  CONTAINER_ENV="${CONTAINER_ENV} -e SERVER_TYPE=navidrome"
  CONTAINER_ENV="${CONTAINER_ENV} -e SERVER_LOCK=true"

  CONTAINER_ENV="${CONTAINER_ENV} -e PUID=$(id -u)"
  CONTAINER_ENV="${CONTAINER_ENV} -e PGID=$(id -g)"

  readonly _env
  return 0
}

_prep_network() {
  # Piggyback onto the navidrome network
  CONTAINER_NETWORK="${CONTAINER_NETWORK} --network=container:navidrome"
  return 0
}

_prep_caps() {
  # For S6
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add CHOWN"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETGID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETUID"
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:9180:9180/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

main "$@" || exit 1
exit 0
