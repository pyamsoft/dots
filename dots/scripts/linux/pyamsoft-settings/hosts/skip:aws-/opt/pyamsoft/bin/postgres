#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

# Migrating major version data:
# https://www.cloudytuts.com/tutorials/docker/how-to-upgrade-postgresql-in-docker-and-kubernetes

# For some reason, on a fresh first launch, the container hangs at:
#
# syncing data to disk ...
#
# Stop the container with `podman stop -t 0 postgres`
# And then start it again and it should start up

NAME="postgres"
IMAGE="docker.io/postgres"
TAG="17.6"

CONTAINER_REQUIRE_RUNCONF=0

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/var/lib/postgresql/data" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/dumps" "/dumps" || return 1

  return 0
}

_prep_caps() {
  # s6
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add DAC_OVERRIDE"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add CHOWN"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETGID"
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add SETUID"

  # To own /var/run/postgresql
  CONTAINER_CAPS="${CONTAINER_CAPS} --cap-add FOWNER"
  return 0
}

_prep_env() {
  CONTAINER_ENV="${CONTAINER_ENV} -e POSTGRES_PASSWORD=mysecretpostgrespasswd"
  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_prep_ports() {
  CONTAINER_PORTS="${CONTAINER_PORTS} -p 127.0.0.1:5432:5432/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Only for podman
  if _is_podman; then
    # Otherwise we keep OCI
    CONTAINER_USERNS="${CONTAINER_USERNS} --userns keep-id"
  fi

  # On MacOS we need to own the files to chown them
  # because just VM things
  if _is_macos; then
    CONTAINER_USERNS="${CONTAINER_USERNS} --user=$(id -u):$(id -g)"
  fi

  return 0
}

main "$@" || exit 1
exit 0
