#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="navidrome"
IMAGE="docker.io/deluan/navidrome"
TAG="0.59.0"

CONTAINER_MEMORY_LIMIT="128M"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/data" || return 1

  # media folders are optionally symlinks to another mass storage drive
  _media="${CONTAINER_RUNTIME_DIR}/${NAME}/media"
  _mount_mkdir "${_media}"

  # Follow the link and mount the music folder ONLY if it is valid
  if [ -d "$(realpath "${_media}")" ]; then
    _add_mounts "--mount type=bind,source=${_media},target=/music"
  fi
  unset _media

  readonly _mounts
  return 0
}

_prep_env() {
  _add_env "-e ND_LOGLEVEL=info"
  return 0
}

_prep_network() {
  if [ -n "${NAVIDROME_PUBLIC}" ] && [ "${NAVIDROME_PUBLIC}" -eq 1 ]; then
    # We continue using the DEFAULT network instead of creating our own.
    # The default network uses the a special setup of the bridge driver
    # which preserves source IP addresses
    #
    # We need to preserve source IP address so that Crowdsec can operate on bad actors
    #
    # However as a trade off, since this runs on the default bridge this decreases network isolation.

    # Just need some statement
    true
  else
    _network_isolate || return 1
  fi
  return 0
}

_prep_caps() {
  return 0
}

_prep_ports() {
  _add_ports "-p 127.0.0.1:4533:4533/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  _add_userns "--user $(id -u):$(id -g)"
  if _is_podman; then
    _add_userns "--userns keep-id"
  fi

  return 0
}

main "$@" || exit 1
exit 0
