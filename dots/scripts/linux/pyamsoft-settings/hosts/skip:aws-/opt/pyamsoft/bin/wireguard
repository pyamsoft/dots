#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

NAME="wireguard"
IMAGE="docker.io/jordanpotter/wireguard"
TAG="2025-12-30"

CONTAINER_NETWORK_HOST_ROUTE=0

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/wg" "/etc/wireguard" || return 1

  # Bind kernel modules
  CONTAINER_MOUNTS="${CONTAINER_MOUNTS} --mount type=bind,source=/lib/modules,target=/lib/modules"

  readonly _mounts
  return 0
}

_prep_caps() {
  # For networking and iptables
  _add_caps "--cap-add NET_ADMIN"
  _add_caps "--cap-add NET_RAW"

  # Optional only if WG module isn't loaded
  _add_caps "--cap-add SYS_MODULE"

  # Needs this for file access and config writing
  # _add_caps "--cap-add CHOWN"
  # _add_caps "--cap-add DAC_OVERRIDE"
  # _add_caps "--cap-add SETGID"
  # _add_caps "--cap-add SETUID"

  return 0
}

_prep_ports() {
  # Configure ports in the runconfig.env
  return 0
}

_prep_env() {
  _add_env "-e PUID=$(id -u)"
  _add_env "-e PGID=$(id -g)"
  return 0
}

_prep_network() {
  _network_isolate || return 1
  return 0
}

_check_user() {
  _require_nonroot || return 1

  return 0
}

_containerize() {
  # Log the commands we use next
  # Fail on errors
  # Fail on unassigned
  set -xeu

  # Don't quote so that if user is empty it still expands
  #
  # shellcheck disable=SC2086
  exec ${CONTAINER_CMD} run \
    --rm \
    --name="${NAME}" \
    --hostname="${NAME}" \
    --security-opt=no-new-privileges:true \
    --cap-drop=ALL \
    --sysctl="net.ipv4.conf.all.src_valid_mark=1" \
    -e LOCAL_SUBNETS="${LOCAL_SUBNETS}" \
    ${CONTAINER_MEMORY} \
    ${CONTAINER_RC} \
    ${CONTAINER_LOGS} \
    ${CONTAINER_NETWORK} \
    ${CONTAINER_ENV} \
    ${CONTAINER_MOUNTS} \
    ${CONTAINER_PORTS} \
    ${CONTAINER_CAPS} \
    ${CONTAINER_USERNS} \
    "${IMAGE}:${TAG}" "$@"
}

main "$@" || exit 1
exit 0
