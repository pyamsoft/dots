#!/bin/sh

# Source our common library
. "/opt/pyamsoft/lib/container-launch"

# Since this container is more of a "library", we could potentially have many instances
# as such, we do NOT need to enforce a hard-set name. A caller could override this by passing NAME=
# themselves when invoking this script.
NAME="${NAME:-caddy}"

IMAGE="ghcr.io/caddybuilds/caddy-cloudflare"
TAG="2.10.2"

_prep_mounts() {
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/data" "/data" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/config" "/config" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/serve" "/serve" || return 1
  _mount_bind "${CONTAINER_RUNTIME_DIR}/${NAME}/logs" "/var/log/caddy" || return 1

  _caddy="/etc/caddy"
  if [ -d "${_caddy}" ]; then
    _mount_bind "${_caddy}" "/etc/caddy" || return 1
  fi
  unset _caddy

  return 0
}

_prep_env() {
  return 0
}

_prep_network() {
  # We continue using the DEFAULT network instead of creating our own.
  # The default network uses the a special setup of the bridge driver
  # which preserves source IP addresses
  #
  # We need to preserve source IP address so that Crowdsec can operate on bad actors
  #
  # However as a trade off, since this runs on the default bridge this decreases network isolation.
  return 0
}

_prep_caps() {
  _add_caps --cap-add NET_BIND_SERVICE
  _add_caps --cap-add NET_ADMIN

  if _is_macos; then
    _add_caps --cap-add DAC_OVERRIDE
  fi

  return 0
}

_prep_ports() {
  # Bind to a non-priv port and force redirect via firewall DNAT
  _add_ports -p "127.0.0.1:3080:80/tcp"
  _add_ports -p "127.0.0.1:3443:443/tcp"
  return 0
}

_check_user() {
  _require_nonroot || return 1

  # Expects to be root (since the cert file is owned by root)
  if _is_podman; then
    _add_userns --userns keep-id
  fi

  return 0
}

_finalize() {
  if _is_podman; then
    if ! _is_cmd_version_atleast 5.4; then
      # Caddy requires podman 5.4 which for some reason is able to support delivering the correct IP
      # to the container
      _elog 'Your %s version must be at least %s to run the %s container' "${CONTAINER_CMD}" 5.4 "${NAME}"
      return 1
    fi
  fi

  return 0
}

main "$@" || exit 1
exit 0
