#!/bin/sh

if [ "$(id -u)" -eq 0 ]; then
  printf -- 'You must run this as a rootless container\n'
  exit 1
fi

# Let it daemonize
if [ "$1" = "-d" ] || [ "$1" = "--detach" ]; then
  shift
  _how="-d"
else
  _how="--rm"
fi
readonly _how

readonly _name="adguardhome"
readonly _image="docker.io/adguard/adguardhome"

readonly _mount1="${HOME}/.containers/containers/${_name}/conf"
readonly _mount2="${HOME}/.containers/containers/${_name}/work"

# Prep the directories
mkdir -p "${_mount1}" || exit 1
mkdir -p "${_mount2}" || exit 1

printf -- 'If you are unable to bind to port 53, you need to expose lower ports to non-root\n'
printf -- 'Run "unsafe-portbind" to temporarily open privileged ports\n'

# Log the commands we use next
# Fail on errors
# Fail on unassigned
set -xeu

exec podman run "${_how}" \
  --name "${_name}" --hostname "${_name}" --pull never \
  --security-opt no-new-privileges:true --cap-drop ALL \
  --mount type=bind,source="${_mount1}",target=/opt/adguardhome/conf \
  --mount type=bind,source="${_mount2}",target=/opt/adguardhome/work \
  -p 127.0.0.1:53:53/tcp \
  -p 127.0.0.1:53:53/udp \
  -p 127.0.0.1:81:81/tcp \
  --cap-add NET_BIND_SERVICE \
  "${_image}" "$@"

