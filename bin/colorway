#!/bin/sh

GNOME_TERMINAL_PROFILE_ID_PYAMSOFT="20e9b532-9ea3-49ae-8d5c-196a171d6435"

_dconf_write() {
  _dconf_key="$1"
  _dconf_value="$2"

  dconf write "${_dconf_key}" "${_dconf_value}" || {
    printf -- 'Failed writing %s to DCONF %s\n' "${_dconf_value}" "${_dconf_key}"
    unset _dconf_key
    unset _dconf_value
    return 1
  }

  unset _dconf_key
  unset _dconf_value
  return 0
}

__ensure_gnome_terminal_profile_list() {
  # Read the current list of profiles
  _gnome_current_profiles="$(dconf read '/org/gnome/terminal/legacy/profiles:/list')"

  if [ -z "${_gnome_current_profiles}" ]; then
    _gnome_current_profiles="[]"
  fi

  _gnome_current_profiles="$(printf -- '%s' "${_gnome_current_profiles}" | sed 's/\[//g' | sed 's/\]//g' | tr ',' '\n' | tr -d ' ')"

  _has_theme=0
  for _p in ${_gnome_current_profiles}; do
    if [ "${_p}" = "'${GNOME_TERMINAL_PROFILE_ID_PYAMSOFT}'" ]; then
      _has_theme=1
      break
    fi
    unset _p
  done
  unset _p

  if [ "${_has_theme}" -ne 1 ]; then
    _gnome_current_profiles="${_gnome_current_profiles}
'${GNOME_TERMINAL_PROFILE_ID_PYAMSOFT}'"
  fi
  unset _has_theme

  _gnome_current_profiles="$(printf -- '%s' "${_gnome_current_profiles}" | sed 's/$/,/g' | tr '\n' ' ' | sed 's/,$//g')"
  _gnome_current_profiles="[${_gnome_current_profiles}]"

  _dconf_write "/org/gnome/terminal/legacy/profiles:/list" "${_gnome_current_profiles}"

  unset _gnome_current_profiles
}

__ensure_gnome_terminal_profile() {
  _gnome_profile_id="$1"
  _gnome_bg_color="$2"
  _gnome_fg_color="$3"
  _gnome_highlight_bg="$4"
  _gnome_highlight_fg="$5"
  _gnome_cursor_bg="$6"
  _gnome_cursor_fg="$7"
  _gnome_palette="$8"

  # Create a new profile and ensure these fields are written to it
  _dconf_profile="/org/gnome/terminal/legacy/profiles:/:${_gnome_profile_id}"
  _dconf_write "${_dconf_profile}/visible-name" "'pyamsoft'"

  _dconf_write "${_dconf_profile}/background-color" "${_gnome_bg_color}"
  _dconf_write "${_dconf_profile}/foreground-color" "${_gnome_fg_color}"

  _dconf_write "${_dconf_profile}/highlight-colors-set" "true"
  _dconf_write "${_dconf_profile}/highlight-background-color" "${_gnome_highlight_bg}"
  _dconf_write "${_dconf_profile}/highlight-foreground-color" "${_gnome_highlight_fg}"

  _dconf_write "${_dconf_profile}/cursor-colors-set" "true"
  _dconf_write "${_dconf_profile}/cursor-background-color" "${_gnome_cursor_bg}"
  _dconf_write "${_dconf_profile}/cursor-foreground-color" "${_gnome_cursor_fg}"

  _dconf_write "${_dconf_profile}/use-theme-colors" "false"
  _dconf_write "${_dconf_profile}/bold-is-bright" "true"

  _dconf_write "${_dconf_profile}/palette" "${_gnome_palette}"

  _dconf_write "${_dconf_profile}/audible-bell" "false"
  _dconf_write "${_dconf_profile}/scrollbar-policy" "'never'"
  _dconf_write "${_dconf_profile}/login-shell" "false"
  _dconf_write "${_dconf_profile}/use-custom-command" "true"
  _dconf_write "${_dconf_profile}/custom-command" "'/usr/bin/tmux -2u'"

  unset _dconf_profile
  unset _gnome_bg_color
  unset _gnome_fg_color
  unset _gnome_highlight_bg
  unset _gnome_highlight_fg
  unset _gnome_cursor_bg
  unset _gnome_cursor_fg
  unset _gnome_palette
  unset _gnome_profile_id
  return 0
}

_light_macos() {
  # MacOS sed is BSD

  # Lunarvim
  if command -v lvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/lvim/config.lua" ]; then
    sed -i '' 's/catppuccin-macchiato/catppuccin-latte/' "${XDG_CONFIG_HOME}/lvim/config.lua"
  fi

  # AstroNvim
  if command -v nvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua" ]; then
    sed -i '' 's/catppuccin-macchiato/catppuccin-latte/' "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua"
  fi

  # Tmux
  if command -v tmux >/dev/null && [ -n "${TMUX}" ]; then
    sed -i '' 's/@catppuccin_flavour "macchiato"/@catppuccin_flavour "latte"/' "${XDG_CONFIG_HOME}/tmux/tmux.conf"
  fi

  # System theme
  if command -v osascript >/dev/null; then
    # https://apple.stackexchange.com/questions/437581/toggle-system-dark-mode-from-terminal
    osascript -e 'tell app "System Events" to tell appearance preferences to set dark mode to no'
  fi

  return 0
}

_light_linux() {
  # Linux is GNU sed

  # Lunarvim
  if command -v lvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/lvim/config.lua" ]; then
    sed -i '0,/catppuccin-macchiato/s//catppuccin-latte/' "${XDG_CONFIG_HOME}/lvim/config.lua"
  fi

  # AstroNvim
  if command -v nvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua" ]; then
    sed -i '0,/catppuccin-macchiato/s//catppuccin-latte/' "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua"
  fi

  # Tmux
  if command -v tmux >/dev/null && [ -n "${TMUX}" ]; then
    sed -i '0,/@catppuccin_flavour "macchiato"/s//@catppuccin_flavour "latte"/' "${XDG_CONFIG_HOME}/tmux/tmux.conf"
  fi

  # Rofi
  if command -v rofi >/dev/null && [ -f "${XDG_CONFIG_HOME}/rofi/config.rasi" ]; then
    sed -i '0,/@theme "rounded-catppuccin-mocha"/s//@theme "rounded-catppuccin-latte"/' "${XDG_CONFIG_HOME}/rofi/config.rasi"
  fi

  # XFCE4 terminal
  if command -v xfconf-query >/dev/null; then
    xfconf-query -c xfce4-terminal -p /color-background -s '#EFF1F5'
    xfconf-query -c xfce4-terminal -p /color-background-vary -s false
    xfconf-query -c xfce4-terminal -p /color-bold -s ''
    xfconf-query -c xfce4-terminal -p /color-bold-is-bright -s true
    xfconf-query -c xfce4-terminal -p /color-bold-use-default -s true
    xfconf-query -c xfce4-terminal -p /color-cursor -s '#DC8A78'
    xfconf-query -c xfce4-terminal -p /color-cursor-foreground -s '#EFF1F5'
    xfconf-query -c xfce4-terminal -p /color-cursor-use-default -s false
    xfconf-query -c xfce4-terminal -p /color-foreground -s '#4C4F69'
    xfconf-query -c xfce4-terminal -p /color-palette -s '#5C5F77;#D20F39;#40A02B;#DF8E1D;#1E66F5;#EA76CB;#179299;#ACB0BE;#6C6F85;#D20F39;#40A02B;#DF8E1D;#1E66F5;#EA76CB;#179299;#BCC0CC'
    xfconf-query -c xfce4-terminal -p /color-selection -s '#4C4F69'
    xfconf-query -c xfce4-terminal -p /color-selection-background -s '#ACB0BE'
    xfconf-query -c xfce4-terminal -p /color-selection-use-default -s false
    xfconf-query -c xfce4-terminal -p /color-use-theme -s false
    xfconf-query -c xfce4-terminal -p /tab-activity-color -s '#FE640B'
  fi

  # GNOME Desktop
  if command -v gsettings >/dev/null && [ -n "${XDG_SESSION_DESKTOP}" ] && { [ "${XDG_SESSION_DESKTOP}" = "gnome" ] || [ "${XDG_SESSION_DESKTOP}" = "gnome-xorg" ]; }; then
    gsettings set org.gnome.desktop.interface icon-theme "Papirus"
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita"         # GTK-3
    gsettings set org.gnome.desktop.interface color-scheme "prefer-light" # GTK-4
  fi

  # Guake
  if command -v guake >/dev/null && command -v dconf >/dev/null; then
    # Need to quote the string
    _dconf_write "/org/guake/style/font/palette" "'#5c5c5f5f7777:#d2d20f0e3939:#4040a0a02b2b:#dfdf8e8e1d1d:#1e1e6665f5f5:#eaea7675cbca:#171792929999:#acacb0b0bebe:#6f6e6f6e8585:#d2d20f0e3939:#4040a0a02b2b:#dfdf8e8e1d1d:#1e1e6665f5f5:#eaea7675cbca:#171792929999:#bcbcc0c0cccc:#4c4c4f4e6969:#efeff1f1f5f5'"
  fi

  # KDE
  if command -v lookandfeeltool >/dev/null && [ -n "${XDG_SESSION_DESKTOP}" ] && [ "${XDG_SESSION_DESKTOP}" = "KDE" ]; then
    lookandfeeltool -a "org.kde.breeze.desktop"

    # Re-apply the icon theme
    printf -- '%s' "$(
      cat <<EOF
[Icons]
Theme=Papirus
EOF
    )" >>"${XDG_CONFIG_HOME}/kdeglobals"

    # Re-apply the splash screen
    printf -- '%s' "$(
      cat <<EOF
[KSplash]
Engine=none
Theme=None
EOF
    )" >>"${XDG_CONFIG_HOME}/ksplashrc"
  fi

  # Flatpak
  if command -v flatpak >/dev/null; then
    flatpak override --user org.pulseaudio.pavucontrol --env=GTK_THEME=Adwaita
    flatpak override --user org.pulseaudio.pavucontrol --env=ICON_THEME=Papirus
  fi

  # GNOME Terminal
  if command -v gnome-terminal >/dev/null && command -v dconf >/dev/null; then
    # You must pick the "pyamsoft" profile in GNOME Terminal for the colors to update in realtime
    __ensure_gnome_terminal_profile \
      "${GNOME_TERMINAL_PROFILE_ID_PYAMSOFT}" \
      "'#eff1f5'" "'#4c4f69'" "'#dc8a78'" "'#acb0be'" "'#dc8a78'" "'#eff1f5'" \
      "['#5c5f77', '#d20f39', '#40a02b', '#df8e1d', '#1e66f5', '#ea76cb', '#179299', '#acb0be', '#6c6f85', '#de293e', '#49af3d', '#eea02d', '#456eff', '#fe85d8', '#2d9fa8', '#bcc0cc']" || return 1

    __ensure_gnome_terminal_profile_list

    # Pick theme
    _dconf_write "/org/gnome/terminal/legacy/profiles:/default" "'${GNOME_TERMINAL_PROFILE_ID_PYAMSOFT}'"
  fi

  return 0
}

_light() {
  if [ "$(uname)" = "Darwin" ]; then
    _light_macos || return 1
  else
    _light_linux || return 1
  fi

  return 0
}

_dark_macos() {
  # MacOS sed is BSD

  # Lunarvim
  if command -v lvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/lvim/config.lua" ]; then
    sed -i '' 's/catppuccin-latte/catppuccin-macchiato/' "${XDG_CONFIG_HOME}/lvim/config.lua"
  fi

  # AstroNvim
  if command -v nvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua" ]; then
    sed -i '' 's/catppuccin-latte/catppuccin-macchiato/' "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua"
  fi

  # Tmux
  if command -v tmux >/dev/null && [ -n "${TMUX}" ]; then
    sed -i '' 's/@catppuccin_flavour "latte"/@catppuccin_flavour "macchiato"/' "${XDG_CONFIG_HOME}/tmux/tmux.conf"
  fi

  # System theme
  if command -v osascript >/dev/null; then
    # https://apple.stackexchange.com/questions/437581/toggle-system-dark-mode-from-terminal
    osascript -e 'tell app "System Events" to tell appearance preferences to set dark mode to yes'
  fi

  return 0
}

_dark_linux() {
  # Linux is GNU sed

  # Lunarvim
  if command -v lvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/lvim/config.lua" ]; then
    sed -i '0,/catppuccin-latte/s//catppuccin-macchiato/' "${XDG_CONFIG_HOME}/lvim/config.lua"
  fi

  # AstroNvim
  if command -v nvim >/dev/null && [ -f "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua" ]; then
    sed -i '0,/catppuccin-latte/s//catppuccin-macchiato/' "${XDG_CONFIG_HOME}/nvim/lua/plugins/astroui.lua"
  fi

  # Tmux
  if command -v tmux >/dev/null && [ -n "${TMUX}" ]; then
    sed -i '0,/@catppuccin_flavour "latte"/s//@catppuccin_flavour "macchiato"/' "${XDG_CONFIG_HOME}/tmux/tmux.conf"
  fi

  # Rofi
  if command -v rofi >/dev/null && [ -f "${XDG_CONFIG_HOME}/rofi/config.rasi" ]; then
    sed -i '0,/@theme "rounded-catppuccin-latte"/s//@theme "rounded-catppuccin-mocha"/' "${XDG_CONFIG_HOME}/rofi/config.rasi"
  fi

  # XFCE4 terminal
  if command -v xfconf-query >/dev/null; then
    xfconf-query -c xfce4-terminal -p /color-background -s '#24273A'
    xfconf-query -c xfce4-terminal -p /color-background-vary -s false
    xfconf-query -c xfce4-terminal -p /color-bold -s ''
    xfconf-query -c xfce4-terminal -p /color-bold-is-bright -s true
    xfconf-query -c xfce4-terminal -p /color-bold-use-default -s true
    xfconf-query -c xfce4-terminal -p /color-cursor -s '#F4DBD6'
    xfconf-query -c xfce4-terminal -p /color-cursor-foreground -s '#181926'
    xfconf-query -c xfce4-terminal -p /color-cursor-use-default -s false
    xfconf-query -c xfce4-terminal -p /color-foreground -s '#CAD3F5'
    xfconf-query -c xfce4-terminal -p /color-palette -s '#494D64;#ED8796;#A6DA95;#EED49F;#8AADF4;#F5BDE6;#8BD5CA;#B8C0E0;#5B6078;#ED8796;#A6DA95;#EED49F;#8AADF4;#F5BDE6;#8BD5CA;#A5ADCB'
    xfconf-query -c xfce4-terminal -p /color-selection -s '#CAD3F5'
    xfconf-query -c xfce4-terminal -p /color-selection-background -s '#5B6078'
    xfconf-query -c xfce4-terminal -p /color-selection-use-default -s false
    xfconf-query -c xfce4-terminal -p /color-use-theme -s false
    xfconf-query -c xfce4-terminal -p /tab-activity-color -s '#F5A97F'
  fi

  # GNOME Desktop
  if command -v gsettings >/dev/null && [ -n "${XDG_SESSION_DESKTOP}" ] && { [ "${XDG_SESSION_DESKTOP}" = "gnome" ] || [ "${XDG_SESSION_DESKTOP}" = "gnome-xorg" ]; }; then
    gsettings set org.gnome.desktop.interface icon-theme "Papirus-Dark"
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"   # GTK-3
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" # GTK-4
  fi

  # Guake
  if command -v dconf >/dev/null && command -v guake >/dev/null; then
    # Need to quote the string
    _dconf_write "/org/guake/style/font/palette" "'#49494d4d6464:#eded87869696:#a6a5dada9595:#eeeed4d49f9f:#8a8aadadf4f4:#f5f5bdbde6e6:#8b8bd5d5caca:#b8b8c0c0e0e0:#5b5a605f7878:#eded87869696:#a6a5dada9595:#eeeed4d49f9f:#8a8aadadf4f4:#f5f5bdbde6e6:#8b8bd5d5caca:#a5a5adadcbcb:#cacad3d3f5f5:#242427273a3a'"
  fi

  # KDE
  if command -v lookandfeeltool >/dev/null && [ -n "${XDG_SESSION_DESKTOP}" ] && [ "${XDG_SESSION_DESKTOP}" = "KDE" ]; then
    lookandfeeltool -a "org.kde.breezedark.desktop"

    # Re-apply the icon theme
    printf -- '%s' "$(
      cat <<EOF
[Icons]
Theme=Papirus-Dark
EOF
    )" >>"${XDG_CONFIG_HOME}/kdeglobals"

    # Re-apply the splash screen
    printf -- '%s' "$(
      cat <<EOF
[KSplash]
Engine=none
Theme=None
EOF
    )" >>"${XDG_CONFIG_HOME}/ksplashrc"
  fi

  # Flatpak
  if command -v flatpak >/dev/null; then
    flatpak override --user org.pulseaudio.pavucontrol --env=GTK_THEME=Adwaita-dark
    flatpak override --user org.pulseaudio.pavucontrol --env=ICON_THEME=Papirus-Dark
  fi

  # GNOME Terminal
  if command -v gnome-terminal >/dev/null && command -v dconf >/dev/null; then
    # You must pick the "pyamsoft" profile in GNOME Terminal for the colors to update in realtime
    __ensure_gnome_terminal_profile \
      "${GNOME_TERMINAL_PROFILE_ID_PYAMSOFT}" \
      "'#24273a'" "'#cad3f5'" "'#f4dbd6'" "'#5b6078'" "'#f4dbd6'" "'#24273a'" \
      "['#45475a', '#f38ba8', '#a6e3a1', '#f9e2af', '#89b4fa', '#f5c2e7', '#94e2d5', '#a6adc8', '#585b70', '#f37799', '#89d88b', '#ebd391', '#74a8fc', '#f2aede', '#6bd7ca', '#bac2de']" || return 1

    __ensure_gnome_terminal_profile_list

    # Pick theme
    _dconf_write "/org/gnome/terminal/legacy/profiles:/default" "'${GNOME_TERMINAL_PROFILE_ID_PYAMSOFT}'"
  fi

  return 0
}

_dark() {
  if [ "$(uname)" = "Darwin" ]; then
    _dark_macos || return 1
  else
    _dark_linux || return 1
  fi

  return 0
}

main() {
  if [ -z "$1" ]; then
    printf -- 'Must provide either "light" or "dark" mode\n'
    return 1
  fi

  if [ "$1" = "light" ] || [ "$1" = "l" ]; then
    _light || return 1
  elif [ "$1" = "dark" ] || [ "$1" = "d" ]; then
    _dark || return 1
  else
    printf -- 'Must provide either "light" or "dark" mode\n'
    return 1
  fi

  if [ -n "${TMUX}" ] && command -v tmux >/dev/null; then
    # Re-source tmux
    tmux source-file "${XDG_CONFIG_HOME}/tmux/tmux.conf"
  fi
}

main "$@" || exit 1
exit 0
