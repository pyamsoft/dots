#!/bin/sh

# Make a self-signed cert

_cleanup() {
  if [ -n "${__config}" ]; then
    rm -f "${__config}" || return 1
  fi

  return 0
}

_make_cert() {

  _name="$1-$2"

  __config="$(mktemp)"
  printf -- '[dn]\nCN=%s\n[req]\ndistinguished_name = dn\n[EXT]\nsubjectAltName=DNS:%s\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth' "${_name}" "${_name}" > "${__config}"

  trap _cleanup INT TERM

  openssl req -x509 \
    -out "${_name}.crt" \
    -keyout "${_name}.key" \
    -newkey rsa:4096 -nodes -sha256 \
    -subj "/CN=${_name}" \
    -extensions EXT \
    -config "${__config}" || return 1

  _cleanup || return 1
  return 0
}

main() {
  _what="$1"

  # Get the hostname
  _hostname=""
  if command -v hostnamectl >/dev/null; then
    _hostname="$(hostnamectl hostname)"
  elif command -v hostname >/dev/null; then
    _hostname="$(hostname)"
  fi

  if [ -z "${_hostname}" ]; then
    printf -- 'Could not discover hostname :(\n'
    return 1
  fi

  if [ -z "${_what}" ]; then
    printf -- 'Must provide a cert name.\n'
    return 1
  fi

  _make_cert "${_hostname}" "${_what}" || return 1
  return 0
}

main "$@" || exit 1
exit 0
