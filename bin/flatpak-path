#!/bin/sh

# Override the flatpak PATH environment

# Defined defaults
readonly __env_var="PATH"
readonly __env_default="/app/bin:/usr/bin"

##
# Main
main()
{
  if ! command -v flatpak-env > /dev/null; then
    printf -- 'You must install "flatpak-env"\n'
    return 1
  fi

  __run_shell=0
  if [ "$1" = "--shell" ]; then
    shift
    __run_shell=1
  fi

  __flatpak="$1"
  __env_arg="$2"

  if [ -z "${__flatpak}" ]; then
    printf -- 'Missing target flatpak\n'

    unset __run_shell
    unset __flatpak
    return 1
  fi

  if [ -z "${__env_arg}" ]; then
    printf -- 'Missing [%s] "%s" env argument\n' "${__flatpak}" "${__env_var}"

    unset __run_shell
    unset __flatpak
    unset __env_arg
    return 1
  fi

  # Run the flatpak or a shell in the flatpak (use /bin/sh, if you need bash, run it in shell)
  if [ "${__run_shell}" -eq 1 ]; then
    exec flatpak-env --shell "${__flatpak}" "PATH" "${__env_arg}:" "${__env_default}" || return 1
  else
    exec flatpak-env "${__flatpak}" "PATH" "${__env_arg}:" "${__env_default}" || return 1
  fi

  unset __run_shell
  unset __flatpak
  unset __env_arg
  return 0
}

main "$@" || exit 1
exit 0
