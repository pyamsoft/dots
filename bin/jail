#!/bin/sh

# A simple jail which isolated user files from the greater HOME directory

# shellcheck disable=SC2155
readonly _PROGRAM="$(basename "$0")"
readonly _VERSION="0.0.1"

# Can be overridden by the environment
readonly JAIL_DIR="${JAIL_DIR:-${HOME}/.local/etc/jails}"

_create_home() {
  _home="$1"
  if [ ! -d "${_home}" ]; then
    # Create the jail root
    mkdir -p "${_home}" || {
      printf -- 'Failed to create jail dir: %s\n' "${_home}"

      unset _home
      return 1
    }
  fi

  unset _home
  return 0
}

_usage() {
  printf -- '%s\n' "$(cat<<EOF
${_PROGRAM} [${_VERSION}]

Runs a command in a jail.
A jail separates the program's \${HOME} from the real user's \$HOME
directory.

Jails are located in: ${JAIL_DIR} by default

EOF
)"
}

_run_jail() {
  _open_shell="$1"
  _cmd="$2"
  _jail="$3"

  # The rest of the arguments are commands
  shift
  shift
  shift

  # If we are opening a shell, override the command
  if [ "${_open_shell}" -eq 1 ]; then
    _cmd="/bin/bash"
  fi

  # dev-bind root so everything works the same as it would outside
  # unshare namespaces [don't unshare net (internet) and don't unshare IPC (x11)]
  # tmpfs bind /tmp for security
  # mount new proc on /proc
  # Mount a new home
  # Mark the process
  set -x
  exec bwrap \
    --dev-bind / / \
    --unshare-user-try \
    --unshare-pid \
    --unshare-uts \
    --unshare-cgroup-try \
    --tmpfs /tmp \
    --proc /proc \
    --bind "${_jail}" "${HOME}" \
    --setenv JAIL_PID "$$" \
    --setenv JAIL_PROGRAM "${_cmd}" \
    -- "${_cmd}" "$@"
}

main() {
  if ! command -v bwrap >/dev/null; then
    printf -- 'Must have "bwrap" installed.\n'
    return 1
  fi

  _cmd="$1"
  if [ -z "${_cmd}" ]; then
    printf -- 'Must provide command as first argument.\n'
    _usage
    return 1
  fi
  shift

  # If we want to open a shell, then the next thing is the command
  if [ "${_cmd}" = "--shell" ]; then
    _open_shell=1
    _cmd="$1"
    if [ -z "${_cmd}" ]; then
      printf -- 'Must provide command as first argument.\n'
      _usage
      return 1
    fi
    shift
  else
    _open_shell=0
  fi

  _jail_dir="${JAIL_DIR}/${_cmd}"
  _create_home "${_jail_dir}" || return 1
  _run_jail "${_open_shell}" "${_cmd}" "${_jail_dir}" "$@" || return 1

  unset _cmd
  unset _jail_dir
  return 0
}

main "$@" || exit 1
exit 0
