#!/bin/sh

_remove_devices() {
  printf -- 'Remove old sunshine devices...\n'
  rm -f "${HOME}/.config/sunshine/sunshine_keyboard" >/dev/null 2>&1
  rm -f "${HOME}/.config/sunshine/sunshine_mouse" >/dev/null 2>&1
  rm -f "${HOME}/.config/sunshine/sunshine_touchscreen" >/dev/null 2>&1
  return 0
}

_restart() {
  printf -- 'Stopping old sunshine service...\n'
  systemctl --user stop sunshine >/dev/null 2>&1

  # Kill any potentially bad symlinks
  _remove_devices || return 1

  printf -- 'Starting new sunshine service...\n'
  systemctl --user restart sunshine >/dev/null 2>&1

  return 0
}

main() {
  if _restart; then
    printf -- 'Restarted sunshine service!\n'
  else
    printf -- 'Failed to restart sunshine\n'
    return 1
  fi

  return 0
}

if command -v sunshine >/dev/null 2>&1; then
  main "$@" || exit 1
  exit 0
else
  printf -- 'sunshine is not installed.\n'
  exit 1
fi
