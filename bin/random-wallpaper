#!/bin/sh

# Sets a random wallpaper with feh

gen_random()
{
  head -200 /dev/urandom | cksum | cut -f1 -d " " || return 1
  return 0
}

##
# $1 - dir
# $2 - file count in dir
random_wall()
{
  random_wall__dir="$1"
  random_wall__count="$2"
  random_wall__index="$(( $(gen_random) % random_wall__count ))"

  find "${random_wall__dir}" -type f | head -n $((random_wall__index + 1)) \
    | tail -n 1 || return 1

  unset random_wall__dir
  unset random_wall__index
  unset random_wall__count
  return 0
}

##
# $1 - pictures dir
random_wall_slideshow()
{
  pictures_dir="$1"
  landscape_dir="${pictures_dir}/landscape"
  portrait_dir="${pictures_dir}/portrait"

  sleep_time="$(( 15 * 60 ))"

  while :; do
    landscape_count="$(find "${landscape_dir}" -type f | wc -l)"
    portrait_count="$(find "${portrait_dir}" -type f | wc -l)"

    landscape_file="$(random_wall "${landscape_dir}" "${landscape_count}")"
    portrait_file="$(random_wall "${portrait_dir}" "${portrait_count}")"
    feh --bg-fill "${landscape_file}" --bg-fill "${portrait_file}" || {
      printf -- 'Failed to set wallpapers to %s and %s\n' "${landscape_file}" \
        "${portrait_file}"
      break
    }

    sleep "${sleep_time}" || {
      printf -- 'Stop slideshow\n'
      break
    }
  done

  unset pictures_dir
  unset landscape_dir
  unset portrait_dir
  unset sleep_time
  return 0
}

main()
{
  if ! which feh > /dev/null 2>&1; then
    printf -- 'Please install "feh" to use this script\n'
    return 1
  fi

  if ! which head > /dev/null 2>&1; then
    printf -- 'Please install "head" to use this script\n'
    return 1
  fi

  if ! which tail > /dev/null 2>&1; then
    printf -- 'Please install "tail" to use this script\n'
    return 1
  fi

  if ! which cksum > /dev/null 2>&1; then
    printf -- 'Please install "cksum" to use this script\n'
    return 1
  fi

  if ! which cut > /dev/null 2>&1; then
    printf -- 'Please install "cut" to use this script\n'
    return 1
  fi

  if ! which wc > /dev/null 2>&1; then
    printf -- 'Please install "wc" to use this script\n'
    return 1
  fi

  if ! which ls > /dev/null 2>&1; then
    printf -- 'Please install "ls" to use this script\n'
    return 1
  fi

  random_wall_slideshow "${HOME}/pictures/wallpapers"
  return 0
}

main "$@" || exit 1
exit 0

