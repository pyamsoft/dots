#!/bin/sh

# Use nvim from distrobox
readonly NAME="nvim"
readonly CMD="nvim"

_run_distrobox() {
  # Clean the path so that we don't conflict with command names
  exec distrobox enter "${NAME}" --clean-path -e "${CMD}" "$@"
}

_has_distrobox() {
  # List all
  # Only take the name column
  # Trim off the name header
  # Grep for matching name
  distrobox ls --no-color | awk '{ print $3 }' | tail -n +2 | grep -q "${NAME}" || return 1
  return 0
}

_make_distrobox() {
  # unshare everything
  # Pre-install programs
  distrobox create --name "${NAME}" --unshare-all --pre-init-hooks 'dnf -y install neovim'
}

main() {
  if ! _has_distrobox "${NAME}"; then
    _make_distrobox "${NAME}" || {
      printf -- 'Failed to create distrobox %s\n' "${NAME}"
      return 1
    }
  fi

  _run_distrobox "$@" || return 1
  return 0
}

main "$@" || exit 1
exit 0
