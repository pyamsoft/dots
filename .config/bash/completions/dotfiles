# shellcheck shell=bash

# Completions for dotfiles commands
#
# This lets us target the correct directory
__dotfiles_comp() {
  GIT_DIR="${HOME}/.dotfiles" GIT_WORK_TREE="${HOME}" __git_wrap__git_main "$@"
}

__dotfiles_wrap() {
  local cmd="$1"
  shift

  # Replace the short hand alias with "dotfiles" for better completion
  #
  # Update the CWORDs to get as close as we can replicate
  # making the command line the same as calling "dotfiles" long form
  local alias_or_command="${COMP_WORDS[0]}"
  if [ "${alias_or_command}" != "dotfiles" ]; then
    # COMP_WORDS for long form looks like
    # (dotfiles fetch origin)
    #
    # But in shorthand alias looks like
    # (dotf origin)
    #
    # We fix the array by shoving the long form "dotfiles fetch" in place of "dotf"

    # Remove the alias
    unset "COMP_WORDS[0]"

    # Replace the array with the longform command
    COMP_WORDS=("dotfiles" "${cmd}" "${COMP_WORDS[@]}")

    # Since we added another argument, bump the CWORD index
    COMP_CWORD=$((COMP_CWORD + 1))

    # Replace the line shorthand with the long form
    COMP_LINE="${COMP_LINE/${alias_or_command}/dotfiles ${cmd}}"

    # There are always three arguments, we need to replace the first with dotfiles
    # and may possibly need to replace the third command IFF the third is the same alias
    # as the first
    #
    # TODO: For some reason, we can't complete -|-- options with the shorthand alias commands
    if [ "${alias_or_command}" = "$3" ]; then
      # Keep only the second command
      set -- "dotfiles" "$2" "${cmd}"
    else
      # Remove the first command
      shift

      # Keep everything else
      set -- "dotfiles" "$@"
    fi
  fi

  __dotfiles_comp "$@"

  unset alias_or_command
  unset cmd
}

__dotfiles_status() {
  __dotfiles_wrap "status" "$@"
}

__dotfiles_add() {
  __dotfiles_wrap "add" "$@"
}

__dotfiles_commit() {
  __dotfiles_wrap "commit" "$@"
}

__dotfiles_diff() {
  __dotfiles_wrap "diff" "$@"
}

__dotfiles_merge() {
  __dotfiles_wrap "merge" "$@"
}

__dotfiles_checkout() {
  __dotfiles_wrap "checkout" "$@"
}

__dotfiles_branch() {
  __dotfiles_wrap "branch" "$@"
}

__dotfiles_pull() {
  __dotfiles_wrap "pull" "$@"
}

__dotfiles_fetch() {
  __dotfiles_wrap "fetch" "$@"
}

__dotfiles_push() {
  __dotfiles_wrap "push" "$@"
}

__dotfiles_log() {
  # lg is our log alias
  __dotfiles_wrap "lg" "$@"
}

# Load the git completion
_comp_load git

# Complete main dotfiles (this completes -|-- options too)
complete -o bashdefault -o default -o nospace -F __dotfiles_comp dotfiles

# Complete aliases (-|-- options are buggy :( )
complete -o bashdefault -o default -o nospace -F __dotfiles_status dots
complete -o bashdefault -o default -o nospace -F __dotfiles_add dota
complete -o bashdefault -o default -o nospace -F __dotfiles_commit dotc
complete -o bashdefault -o default -o nospace -F __dotfiles_diff dotd
complete -o bashdefault -o default -o nospace -F __dotfiles_merge dotm
complete -o bashdefault -o default -o nospace -F __dotfiles_checkout dotck
complete -o bashdefault -o default -o nospace -F __dotfiles_branch dotb
complete -o bashdefault -o default -o nospace -F __dotfiles_pull dotpl
complete -o bashdefault -o default -o nospace -F __dotfiles_fetch dotf
complete -o bashdefault -o default -o nospace -F __dotfiles_push dotps
complete -o bashdefault -o default -o nospace -F __dotfiles_log dotl
