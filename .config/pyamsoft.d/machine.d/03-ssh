# shellcheck shell=bash

# SSH socket defined, do nothing
if [ -n "${SSH_AUTH_SOCK}" ]; then
  return 0
fi

# Otherwise figure out an SSH agent home
if [ -z "${XDG_RUNTIME_DIR}" ]; then
  _ssh_home="${TMPDIR:-/tmp}"
else
  _ssh_home="${XDG_RUNTIME_DIR}"
fi

# And now mark the SSH directory per user
_ssh_home="${_ssh_home}/pyamsoft-$(id -u)/ssh"
_agent_path="${_ssh_home}/ssh-agent.env"

# Check if an SSH agent is already running
if ! pgrep -u "$(id -un)" ssh-agent >/dev/null; then
  # Clear the old directory
  if rm -rf "${_ssh_home}" >/dev/null 2>&1; then
    # Make a new directory
    if mkdir -p "${_ssh_home}"; then
      # Launch a new agent and save the details in this runtime file
      ssh-agent -s >"${_agent_path}"
    else
      printf -- 'Failed to create new SSH environment directory: %s\n' "${_ssh_home}"
    fi
  else
    printf -- 'Failed to clear old SSH environment directory: %s\n' "${_ssh_home}"
  fi
fi

if [ -f "${_agent_path}" ]; then
  # shellcheck disable=SC1090
  . "${_agent_path}" >/dev/null 2>&1

  # Set up machine
  if [ -z "${PYAMSOFT_MACHINE}" ]; then
    PYAMSOFT_MACHINE="ssh"
  else
    PYAMSOFT_MACHINE="ssh:${PYAMSOFT_MACHINE}"
  fi
fi

unset _agent_path
unset _ssh_home

return 0
